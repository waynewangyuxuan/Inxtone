# Milestone 7: Quality & Visualizations

- **Status**: Draft
- **Target Date**: TBD (after M6)
- **Owner**: Wayne
- **Duration**: 2 weeks
- **Dependencies**: M6 (Smart Intake)

## Goal

Give writers the ability to **see and verify their story's structural integrity**. The QualityService catches consistency issues automatically, while visualizations (relationship map, timeline, pacing) make story structure tangible. After M7, writers can trust that Inxtone watches for mistakes they might miss.

## Success Criteria

```
✓ QualityService runs 26 consistency rules across 6 dimensions
✓ Quality panel shows issues with severity, location, and suggestions
✓ Wayne Principles automated checking
✓ Relationship map visualization (force-directed graph) — Issue #4
✓ Timeline visualization (chronological event display) — Issue #5
✓ Pacing visualization (word count / emotion curve per chapter) — Issue #6
✓ CLI `inxtone check` command
```

## Scope

### In Scope

1. **QualityService (P0)**
   - 26 consistency rules across 6 dimensions
     - Character consistency (6): voice, behavior, power, dialogue distinction, arc progression, relationship evolution
     - World consistency (4): rule violations, location match, faction stance, timeline order
     - Plot consistency (4): foreshadowing status, subplot alignment, arc structure, MC arc sync
     - Wayne principles (4+2): R1-R4 red lines + P1-P4 core principles
     - Pacing & quality (4): golden chapters, emotion curve, chapter hooks, repetition detection
     - Text quality (2): writing traps detection
   - Check scheduling: on-demand / on-chapter-complete / every-10-chapters
   - Issue aggregation with severity levels

2. **Quality Panel UI (P0)**
   - Quality tab in sidebar or dedicated panel
   - Issue list: severity, rule, location (chapter + entity), description
   - Issue detail: explanation, suggestion, link to source
   - Run check button (manual trigger)
   - Wayne Principle check summary card
   - Consistency badge on chapters

3. **Relationship Map (P0)** — Issue #4
   - Force-directed graph visualization (D3-force or react-force-graph)
   - Nodes: character name, role badge
   - Edges: relationship type label, line style by dynamic (ally/rival/complex)
   - Click node → Bible panel scrolls to character
   - Filter by: arc involvement, faction, relationship type
   - Hover node: highlight connected edges
   - Zoom + pan + fit-to-screen

4. **Timeline Visualization (P0)** — Issue #5
   - Horizontal or vertical chronological display
   - Event cards: title, date, linked characters, linked chapter
   - Arc boundary markers (colored bands or dividers)
   - Click event → navigate to linked chapter or entity
   - Filter by arc, character involvement

5. **Pacing Visualization (P0)** — Issue #6
   - Word count bar chart per chapter
   - Emotion/intensity line chart overlay
   - Golden chapter markers (flagged in outline as high-stakes)
   - Click chapter bar → navigate to chapter
   - Toggle between word count / emotion / combined views

6. **CLI: `inxtone check` (P1)**
   - Run quality checks from command line
   - Print report with severity levels and locations

### Out of Scope

- Semantic search (sqlite-vec) → M8
- Auto-suggest entity links → M8
- Version history + diff viewer → M8
- CLI `search`, `config`, shell completion → M8
- Performance optimization → M8
- Documentation & release → M8
- Multi-model AI (Claude, GPT, Ollama) → M9+
- EPUB/PDF export → M9+

## Deliverables

| # | Deliverable | Acceptance Criteria |
|---|-------------|---------------------|
| 1 | **QualityService** | 26 rules implemented, check scheduling, issue aggregation |
| 2 | **Quality Panel** | Issue list/detail, manual trigger, consistency badges |
| 3 | **Relationship Map** | Force-directed graph renders, click navigates, filters work |
| 4 | **Timeline Visualization** | Events display chronologically, linked to chapters/entities |
| 5 | **Pacing Visualization** | Word count bars + emotion curve + golden chapter markers |
| 6 | **CLI `inxtone check`** | Quality checks run from CLI, formatted report output |

---

## Tasks

### Phase 1: QualityService (Day 1-6)

- [ ] QualityService interface and implementation
  - [ ] Rule engine: load rules from config, execute, aggregate results
  - [ ] Issue type: `{ rule, severity, entityType, entityId, chapterId?, description, suggestion }`
  - [ ] Batch check: run all applicable rules for a scope (chapter / volume / all)
- [ ] Implement consistency rules (26 total)
  - [ ] Character rules (6): voice drift, behavior contradiction, power level violation, dialogue indistinction, arc stagnation, relationship regression
  - [ ] World rules (4): rule violations, location mismatch, faction stance contradiction, timeline disorder
  - [ ] Plot rules (4): foreshadowing status tracking, subplot drift, arc structure violation, MC arc desync
  - [ ] Wayne principles (6): R1-R4 red lines + P1-P4 core principles
  - [ ] Pacing rules (4): golden chapter density, emotion curve flatness, chapter hook weakness, repetition detection
  - [ ] Text quality rules (2): writing traps detection
- [ ] Check scheduling
  - [ ] On-demand (manual trigger)
  - [ ] On chapter complete (status → 'done')
  - [ ] Periodic (every N chapters)
- [ ] Quality panel UI
  - [ ] Issue list with filters (severity, type, chapter)
  - [ ] Issue detail view with suggestion
  - [ ] Run check button
  - [ ] Consistency badges on chapter list
  - [ ] Wayne Principle check summary card
- [ ] Quality API routes
  - [ ] `POST /api/quality/check` — run checks
  - [ ] `GET /api/quality/issues` — list issues
  - [ ] `GET /api/quality/summary` — overview stats
- [ ] CLI: `inxtone check` — run quality checks, print report
- [ ] Tests: each rule produces correct issues for known-bad input

### Phase 2: Visualizations (Day 5-10)

#### Relationship Map (Day 5-7)

- [ ] `RelationshipMap.tsx` component
  - [ ] Force-directed graph (D3-force or react-force-graph)
  - [ ] Nodes: character name, role badge, optional avatar
  - [ ] Edges: relationship type label, line style by dynamic (ally/rival/complex)
  - [ ] Color coding by faction or arc involvement
- [ ] Interactions
  - [ ] Hover node: highlight connected edges
  - [ ] Click node: open character detail in Bible panel
  - [ ] Zoom + pan + fit-to-screen
  - [ ] Filter controls: by arc, faction, relationship type
- [ ] Data source: `GET /api/bible/characters` + `GET /api/bible/relationships`
- [ ] Layout in Bible tab or dedicated "Map" tab in left sidebar

#### Timeline Visualization (Day 7-8)

- [ ] `TimelineView.tsx` component
  - [ ] Horizontal or vertical chronological display
  - [ ] Event cards: title, date, linked characters, linked chapter
  - [ ] Arc boundary markers (colored bands or dividers)
  - [ ] Zoom levels: overview (all events) / arc-level / chapter-level
- [ ] Interactions
  - [ ] Click event → navigate to linked chapter or entity
  - [ ] Hover: preview event details
  - [ ] Filter by arc, character involvement
- [ ] Data source: `GET /api/bible/timeline` + arc data

#### Pacing Visualization (Day 8-10)

- [ ] `PacingView.tsx` component
  - [ ] Word count bar chart (per chapter, stacked by volume)
  - [ ] Emotion/intensity line chart overlay
  - [ ] Golden chapter markers (flagged in outline as high-stakes)
  - [ ] Chapter-type heatmap (action / dialogue / introspection)
- [ ] Interactions
  - [ ] Click chapter bar → navigate to chapter
  - [ ] Hover: show word count, outline goal, emotion tag
  - [ ] Toggle between word count / emotion / combined views
- [ ] Data source: chapters (word count), outlines (emotion tags, golden flag)

### Phase 3: Integration + Polish (Day 9-14)

- [ ] Quality ↔ Visualization integration
  - [ ] Pacing issues link to pacing visualization
  - [ ] Character consistency issues link to relationship map
  - [ ] Timeline violations link to timeline view
- [ ] Visual polish
  - [ ] Loading states for visualizations and quality panel
  - [ ] Empty states ("No relationships → add relationships to see the map")
  - [ ] Error boundaries for visualization failures
  - [ ] Responsive layout for all new panels
- [ ] Visualization tabs: smooth transitions
- [ ] Tests: visualization rendering with demo data, quality-to-viz navigation

---

## Test Plan

### Unit Tests
- [ ] Each quality rule produces correct issues for known-bad input
- [ ] Rule engine aggregation: severity sorting, deduplication
- [ ] Check scheduling triggers at correct times

### Integration Tests
- [ ] Full quality pipeline: create entities with issues → run check → verify issues detected
- [ ] Quality API routes: check → list issues → summary matches
- [ ] Visualization data: relationship map renders with demo data, timeline orders correctly

### E2E Tests
- [ ] Quality panel: run check → see issues → click issue → navigate to entity
- [ ] Relationship map: renders with demo data, click node → Bible panel opens
- [ ] Timeline: events display, click → navigate to chapter
- [ ] Pacing: bars render, golden chapters marked, click → navigate

---

## Technical Notes

### Quality Rule Architecture

```typescript
interface QualityRule {
  id: string;
  name: string;
  dimension: 'character' | 'world' | 'plot' | 'wayne' | 'pacing' | 'text';
  severity: 'error' | 'warning' | 'info';
  schedule: 'realtime' | 'on-complete' | 'periodic';
  check(context: CheckContext): QualityIssue[];
}

interface QualityIssue {
  rule: string;
  severity: 'error' | 'warning' | 'info';
  entityType: string;
  entityId: string;
  chapterId?: string;
  description: string;
  suggestion: string;
}
```

### Visualization Libraries

| Visualization | Library | Rationale |
|---------------|---------|-----------|
| Relationship Map | `d3-force` + React SVG | Fine-grained control, no heavy deps |
| Timeline | Custom React + CSS | Simple enough, avoids timeline lib overhead |
| Pacing Charts | `recharts` | Lightweight React charts |

---

## Dependencies

- M6 (Smart Intake) — quality needs data volume to be meaningful
- D3 or equivalent for force-directed graph
- Recharts or equivalent for charts

## Risks

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Quality rules too simplistic | Medium | Medium | Start with high-confidence rules, iterate based on feedback |
| Visualization performance with large cast (50+) | Medium | Medium | Lazy render, cluster nodes, limit visible by arc |
| 26 rules takes longer than expected | Medium | Medium | Prioritize Wayne Principles + Character rules first |
| Scope creep from visualization polish | Medium | High | P0 = functional; visual polish trimmable |

---

## Notes

- Quality + Visualizations 服务同一个用户目标：**审视和验证故事结构完整性**
- Quality 规则可以迭代 — 先实现高信度规则，后续版本逐步增加
- Visualizations 从 M4.5 defer 过来（Issues #4-6） — 用户明确要求，优先级不能再降
- Relationship map 是用户最直观感知"这个工具懂我的故事"的 feature
- Search 已在 M4.5 完成（FTS5 + Cmd+K），M7 不重复
