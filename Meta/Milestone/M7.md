# Milestone 7: Search, Quality & Polish

- **Status**: Draft
- **Target Date**: TBD (after M6)
- **Owner**: Wayne
- **Duration**: 3 weeks
- **Dependencies**: M6 (Smart Intake)

## Goal

Implement full-text and semantic search, the QualityService consistency checker, and application-wide polish (performance, docs, CLI, accessibility). This is the milestone that makes Inxtone production-ready for v0.1.0 release. Depends on M6 (Smart Intake) because search and quality need real data volume to be meaningful.

## Success Criteria

```
✓ Cmd+K search modal with instant full-text results across all entities
✓ Semantic search via sqlite-vec embeddings
✓ QualityService runs 26 consistency rules
✓ Quality panel shows issues with severity and location
✓ Wayne Principles automated checking
✓ CLI `inxtone check` and `inxtone search` commands
✓ Performance targets met (startup < 500ms, idle memory < 100MB)
✓ Documentation complete (README, Getting Started, CLI reference)
✓ v0.1.0 tagged and published
```

## Scope

### In Scope

1. **Full-Text Search (P0)**
   - FTS5 virtual table across characters, chapters, world, arcs, foreshadowing
   - Cmd+K modal in Web UI — instant search as you type
   - Search results grouped by entity type, linked to detail views
   - CLI: `inxtone search "<query>"`

2. **Semantic Search (P1)**
   - sqlite-vec embedding storage
   - Gemini embedding API integration
   - Index: characters, world, chapters, outlines
   - Chunking: max 500 chars, 50-char overlap
   - Hybrid ranking: FTS5 score + vector similarity

3. **QualityService (P0)**
   - 26 consistency rules across 6 dimensions
     - Character consistency (6): voice, behavior, power, dialogue distinction, arc progression, relationship evolution
     - World consistency (4): rule violations, location match, faction stance, timeline order
     - Plot consistency (4): foreshadowing status, subplot alignment, arc structure, MC arc sync
     - Wayne principles (4+2): R1-R4 red lines + P1-P4 core principles
     - Pacing & quality (4): golden chapters, emotion curve, chapter hooks, repetition detection
     - Text quality (2): writing traps detection
   - Check scheduling: realtime / on-chapter-complete / every-10-chapters / event-triggered
   - Issue aggregation with severity levels

4. **Quality Panel UI (P0)**
   - Quality tab in sidebar or dedicated panel
   - Issue list: severity, rule, location (chapter + entity), description
   - Issue detail: explanation, suggestion, link to source
   - Run check button (manual trigger)
   - Wayne Principle check summary card
   - Consistency badge on chapters

5. **Auto-Suggest Entity Links (P1)**
   - Detect entity mentions in chapter text
   - Suggest links to Story Bible entries
   - Interactive StoryBiblePanel in editor sidebar

6. **Version History (P1)**
   - Version history panel for chapters
   - Diff viewer between versions
   - Restore from version
   - Volume switcher

7. **CLI Completeness (P0)**
   - `inxtone check` — run quality checks
   - `inxtone search` — full-text search
   - `inxtone config` — configuration management
   - Shell completion (bash, zsh, fish)
   - Improved help text across all commands

8. **Performance & Polish (P0)**
   - Startup time < 500ms
   - Idle memory < 100MB
   - Loading states, error boundaries, empty states
   - Keyboard shortcuts
   - Responsive design fixes

9. **Documentation & Release (P0)**
   - README.md with screenshots
   - Getting Started guide
   - CLI reference
   - API documentation
   - Contributing guide
   - v0.1.0 release tag

### Out of Scope

- Multi-model AI (Claude, GPT, Ollama) → M8
- Relationship graph visualization → M8
- EPUB/PDF export → M8
- Plugin/extension system → M9
- Cloud sync → M9
- Ambient entity detection during writing → M8

## Deliverables

| # | Deliverable | Acceptance Criteria |
|---|-------------|---------------------|
| 1 | **SearchService** | FTS5 + semantic search, Cmd+K modal, CLI command |
| 2 | **QualityService** | 26 rules implemented, check scheduling, issue aggregation |
| 3 | **Quality Panel** | Issue list/detail, manual trigger, badges |
| 4 | **Entity Links** | Auto-detect mentions, suggest links, interactive panel |
| 5 | **Version History** | Version list, diff viewer, restore |
| 6 | **CLI Complete** | All commands documented and functional |
| 7 | **Performance** | All metrics met |
| 8 | **Documentation** | README, guides, API docs |
| 9 | **v0.1.0 Release** | Tagged, CHANGELOG complete |

---

## Tasks

### Phase 1: Search (Day 1-5)

- [ ] FTS5 virtual table migration
  - [ ] Index: characters (name, appearance, motivation), chapters (title, content), world, arcs, foreshadowing, locations, factions
  - [ ] Triggers for auto-update on insert/update/delete
- [ ] SearchService implementation
  - [ ] `search(query, options?)` — FTS5 query with ranking
  - [ ] Results grouped by entity type
  - [ ] Highlight matching snippets
- [ ] Cmd+K search modal
  - [ ] Keyboard shortcut trigger
  - [ ] Instant search as you type (debounced)
  - [ ] Result cards with entity type icon, name, snippet
  - [ ] Click result → navigate to entity detail
- [ ] sqlite-vec integration (P1)
  - [ ] Embedding table migration
  - [ ] Gemini embedding API calls
  - [ ] Index existing entities on first run
  - [ ] Hybrid ranking: combine FTS5 + vector scores
- [ ] CLI: `inxtone search "<query>"`
- [ ] Tests: FTS5 indexing, search accuracy, ranking

### Phase 2: Quality (Day 5-12)

- [ ] QualityService interface and implementation
  - [ ] Rule engine: load rules from config, execute, aggregate results
  - [ ] Issue type: `{ rule, severity, entityType, entityId, chapterId?, description, suggestion }`
  - [ ] Batch check: run all applicable rules for a scope (chapter / volume / all)
- [ ] Implement consistency rules (26 total)
  - [ ] Character rules (6)
  - [ ] World rules (4)
  - [ ] Plot rules (4)
  - [ ] Wayne principles (6)
  - [ ] Pacing rules (4)
  - [ ] Text quality rules (2)
- [ ] Check scheduling
  - [ ] On-demand (manual trigger)
  - [ ] On chapter complete
  - [ ] Periodic (every N chapters)
- [ ] Quality panel UI
  - [ ] Issue list with filters (severity, type, chapter)
  - [ ] Issue detail view
  - [ ] Run check button
  - [ ] Consistency badges on chapter list
- [ ] Quality API routes
  - [ ] `POST /api/quality/check` — run checks
  - [ ] `GET /api/quality/issues` — list issues
  - [ ] `GET /api/quality/summary` — overview stats
- [ ] CLI: `inxtone check` — run quality checks, print report
- [ ] Tests: each rule produces correct issues for known-bad input

### Phase 3: Entity Links + Version History (Day 10-15)

- [ ] Auto-suggest entity links
  - [ ] Text analysis: detect character names, location names in chapter content
  - [ ] Suggestion UI: inline highlights or sidebar suggestions
  - [ ] Click to link → navigate to Story Bible entry
- [ ] Interactive StoryBiblePanel
  - [ ] Quick-reference panel in editor sidebar
  - [ ] Shows entities related to current chapter
  - [ ] Click to expand details
- [ ] Version history
  - [ ] Version list panel for chapters
  - [ ] Diff viewer (visual diff between versions)
  - [ ] Restore button → creates new version from old content
  - [ ] Volume switcher in sidebar
- [ ] Tests: entity detection accuracy, version create/restore/diff

### Phase 4: CLI + Performance + Docs + Release (Day 14-21)

- [ ] CLI completeness
  - [ ] `inxtone config list/get/set`
  - [ ] Shell completion scripts
  - [ ] Help text review for all commands
- [ ] Performance optimization
  - [ ] Profile startup time, optimize lazy loading
  - [ ] Database query audit
  - [ ] Memory usage monitoring
- [ ] UI polish
  - [ ] Loading states everywhere
  - [ ] Error boundaries
  - [ ] Empty states
  - [ ] Keyboard shortcuts reference
- [ ] Documentation
  - [ ] README.md rewrite with screenshots
  - [ ] Getting Started guide
  - [ ] CLI reference
  - [ ] API endpoint documentation
  - [ ] Contributing guide
- [ ] Release
  - [ ] Version bump to 0.1.0
  - [ ] CHANGELOG.md
  - [ ] GitHub release
  - [ ] Social media assets

---

## Dependencies

- M6 (Smart Intake) complete — users have real data in Story Bibles
- sqlite-vec npm package — for embedding storage
- Gemini embedding API — for vector generation

## Risks

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Milestone too large (3 weeks) | High | Medium | Phase 1-2 are core; Phase 3-4 can be trimmed or split to M7.5 |
| sqlite-vec compatibility | Medium | High | Test early; fallback to FTS5-only if needed |
| Quality rules too simplistic | Medium | Medium | Start with high-confidence rules, iterate based on user feedback |
| Documentation takes longer than expected | Medium | Low | Write incrementally during development, not all at end |

---

## Notes

- 这是 v0.1.0 release milestone — 完成后 Inxtone 正式可用
- Quality 规则可以迭代 — 先实现高信度规则，后续版本逐步增加
- 如果 milestone 过大，优先砍 P1 项目（semantic search、entity links、version history），保 P0
- Search + Quality 在 Intake 之后才有意义：没有数据的搜索是空搜索，没有数据的质量检查是空检查
