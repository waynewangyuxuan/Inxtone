# Milestone 1: Foundation + Interface Contract

- **Status**: Complete
- **Target Date**: 2026-02-28
- **Owner**: Wayne

## Goal

Establish the foundational project structure with **complete interface definitions** and **test infrastructure**, enabling parallel development of M2-M4 via git worktree.

## Success Criteria

After M1, developers should be able to:

```
✓ git worktree add ../feat-xxx feat/m2-story-bible
✓ Import interfaces: import { ICharacterService } from '@inxtone/core'
✓ Run contract tests: pnpm test:contracts
✓ See working skeleton: inxtone serve → localhost:3456
```

## Scope

### In Scope

1. **Interface Contract** (并行开发的前提)
   - All Service interfaces (ICharacterService, IChapterService, etc.)
   - All Entity types (Character, Chapter, World, etc.)
   - API endpoint types (request/response)
   - Event types (EventBus)

2. **Test Infrastructure**
   - Vitest setup with coverage
   - Mock factories for test data
   - Contract test templates
   - In-memory SQLite for tests

3. **Walking Skeleton**
   - pnpm monorepo (packages/core, tui, web, server)
   - `inxtone --version`, `inxtone serve`
   - SQLite database initialization
   - Basic web UI shell

4. **Dev Experience**
   - TypeScript strict mode
   - ESLint + Prettier
   - Hot reload (dev mode)

### Out of Scope

- Feature implementations (M2-M4)
- AI integration
- Quality checking
- Export functionality

## Deliverables

| # | Deliverable | Acceptance Criteria |
|---|-------------|---------------------|
| 1 | **Interface Package** | `@inxtone/core` exports all interfaces |
| 2 | **Test Infrastructure** | `pnpm test` runs, `pnpm test:contracts` exists |
| 3 | **CLI Shell** | `inxtone --version` works |
| 4 | **Server Shell** | `inxtone serve` starts on :3456 |
| 5 | **Web Shell** | Browser shows empty dashboard |
| 6 | **Database** | SQLite schema created with all tables |

---

## Tasks

### Phase 1: Project Setup (Day 1-2)

- [ ] Initialize pnpm workspace
  ```
  packages/
  ├── core/     # Shared types, interfaces, utils
  ├── tui/      # Ink CLI app
  ├── web/      # React + Vite
  └── server/   # Fastify HTTP server
  ```
- [ ] Configure TypeScript (`tsconfig.json`, strict mode)
- [ ] Set up ESLint + Prettier
- [ ] Configure Vitest
- [ ] Create `pnpm dev`, `pnpm build`, `pnpm test` scripts

### Phase 2: Interface Contract (Day 3-5) ⭐ 关键

**Entity Types** (`packages/core/src/types/entities.ts`):

- [ ] `Character` - 角色实体
- [ ] `Chapter` - 章节实体
- [ ] `World` - 世界观 (rules, locations, factions)
- [ ] `Plot` - 剧情 (arcs, outlines, foreshadowing)
- [ ] `Project` - 项目配置

**Service Interfaces** (`packages/core/src/types/services.ts`):

- [ ] `IStoryBibleService` - 角色/世界/剧情 CRUD
- [ ] `IWritingService` - 章节编辑、版本
- [ ] `IAIService` - AI 调用、Context 构建
- [ ] `IQualityService` - 一致性检查
- [ ] `ISearchService` - 全文/语义搜索
- [ ] `IExportService` - 导出
- [ ] `IConfigService` - 配置管理

**API Types** (`packages/core/src/types/api.ts`):

- [ ] REST endpoint request/response types
- [ ] Error response types

**Event Types** (`packages/core/src/types/events.ts`):

- [ ] `CharacterCreated`, `CharacterUpdated`, etc.
- [ ] `ChapterSaved`, `ChapterVersionCreated`
- [ ] `AIStreamChunk`, `AIStreamComplete`

### Phase 3: Test Infrastructure (Day 6-7)

- [ ] Create `vitest.config.ts` with coverage
- [ ] Create mock factory (`__tests__/utils/mock-factory.ts`)
  ```typescript
  export const createMockCharacter = (overrides?: Partial<Character>): Character => ({
    id: 'char-001',
    name: '林逸',
    // ...defaults
    ...overrides
  });
  ```
- [ ] Create test database util (`__tests__/utils/test-db.ts`)
  ```typescript
  export const createTestDb = () => new Database(':memory:');
  ```
- [ ] Create contract test template (`__tests__/contracts/`)
- [ ] Add `pnpm test:contracts` script

### Phase 4: Database Schema (Day 8-9)

- [ ] Create `Database` class with better-sqlite3
- [ ] Implement migration system
- [ ] Create initial schema migration (all tables from 04_DATA_LAYER.md)
- [ ] Add `pnpm db:migrate` script
- [ ] Write schema tests

### Phase 5: CLI Shell (Day 10-11)

- [ ] Create CLI entry point with Ink
- [ ] Implement `inxtone --version`
- [ ] Implement `inxtone --help`
- [ ] Implement `inxtone init [name]`
- [ ] Implement `inxtone serve [--port] [--no-tui]`

### Phase 6: Server + Web Shell (Day 12-14)

**Server:**
- [ ] Set up Fastify server
- [ ] Add health check endpoint (`GET /api/health`)
- [ ] Add static file serving for web build
- [ ] Add CORS for development

**Web:**
- [ ] Scaffold React + Vite app
- [ ] Create AppShell component (header, sidebar, content)
- [ ] Implement routing (`/`, `/bible`, `/write`, `/settings`)
- [ ] Add empty dashboard placeholder
- [ ] Apply design system tokens

---

## Test Plan

### Unit Tests
- [ ] Entity type validation tests
- [ ] Config loader tests
- [ ] Database migration tests

### Contract Tests
- [ ] All interfaces have contract tests
- [ ] Type-level checks compile

### Integration Tests
- [ ] CLI → Server communication
- [ ] Database initialization flow

### E2E Tests
- [ ] `inxtone init test-project` creates valid structure
- [ ] `inxtone serve` → browser shows UI

---

## Dependencies

- None (first milestone)

## Risks

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Interface design changes in M2+ | Medium | Medium | Design review before M1 completion |
| Ink compatibility issues | Low | Medium | Test early, have fallback |
| SQLite binding issues | Low | High | Use well-maintained better-sqlite3 |

---

## Notes

- **M1 的核心价值**: 建立 Interface Contract，使 M2-M4 可以并行开发
- Phase 2 (Interface Contract) 是最关键的阶段，需要仔细设计
- 完成 M1 后，立即开 3 个 worktree 开始 M2-M4

---

## Checklist for Parallel Dev Readiness

M1 完成前的最终检查：

- [ ] `packages/core` exports all interfaces
- [ ] All interfaces have JSDoc comments
- [ ] Contract tests exist for all services
- [ ] `pnpm test:contracts` passes
- [ ] `pnpm typecheck` passes
- [ ] Walking skeleton runs end-to-end
