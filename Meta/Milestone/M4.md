# Milestone 4: AI Quality + Writing UX

- **Status**: In Progress
- **Target Date**: 2026-02-20
- **Owner**: Wayne
- **Duration**: 10 days
- **Dependencies**: M3 (Writing Workspace)

## Goal

Close remaining AI quality bugs, deliver writing UX features users need, and address high-priority tech debt. FTS/semantic search and QualityService deferred to M5.

## Success Criteria

```
✓ Chapter ordering works correctly (sort_order, not creation ID)
✓ Auto-save prevents data loss during writing sessions
✓ Prompt presets provide quick AI instruction chips
✓ Chapter outlines are editable in the UI
✓ Brainstorm mode returns selectable suggestion cards
✓ Code review issues addressed (8 critical/high fixes)
✓ All 17 GitHub issues closed
```

## Scope

### In Scope

1. **AI Quality Bug** — Chapter ordering (#25)
2. **Auto-save** — Debounced save without version creation (#31)
3. **Prompt Presets** — Clickable instruction chips (#32)
4. **Outline Editing** — UI for chapter goal/scenes/hookEnding (#33)
5. **Brainstorm Redesign** — Selectable suggestion cards (#37)
6. **Tech Debt** — JSON parsing safety (#2), type assertions (#3), error tests (#6), PR review fixes (#42)
7. **Code Review Fixes** — 8 critical/high issues from comprehensive review

### Out of Scope (Deferred to M5)

- FTS5 search + Cmd+K modal
- Semantic search / embeddings (sqlite-vec)
- QualityService + quality panel
- CLI `inxtone check`
- Auto-suggest entity links (#28)
- Interactive StoryBiblePanel (#34)
- Version history + volume switcher (#35)

## Issue Mapping

| Phase | Closes | Count |
|-------|--------|-------|
| Pre-Phase | #20, #21, #22, #23, #24, #26, #27, #29 | 8 |
| Phase 1 | #25 | 1 |
| Phase 2 | #31 | 1 |
| Phase 3 | #32 | 1 |
| Phase 4 | #33 | 1 |
| Phase 5 | #37 | 1 |
| Phase 6 | #2, #3, #6, #42 | 4 |
| **Total** | | **17** |

---

## Tasks

### Pre-Phase: Close Already-Fixed Issues ✅

Issues #20-24, #26-27, #29 were already fixed in the codebase during M3 development. Closed with code references.

### Phase 1: Chapter Ordering ✅ (#25)

- [x] Migration 002: `sort_order INTEGER` column + backfill + composite index
- [x] Update `WritingRepository`: all queries use `ORDER BY sort_order ASC, id ASC`
- [x] `createChapter()`: auto-assign `MAX(sort_order) + 1` within volume
- [x] Real `reorderChapters()`: updates sort_order by array position
- [x] Add `sortOrder: number` to Chapter entity type
- [x] Tests: 1016 passing, typecheck clean

### Code Review Fixes ✅

- [x] ChapterListPanel: sort by `sortOrder` (not `id`)
- [x] ChapterListPanel: defer selection clear to delete `onSuccess`
- [x] ContextPreview: consistent ID fallback (`idx-N`) in count + render
- [x] AcceptPreviewModal: ensure exactly `\n\n` paragraph breaks
- [x] StreamingResponse: only auto-scroll when near bottom
- [x] AISidebar: abort stream on chapter switch (prevents wrong-chapter accept)
- [x] AIService: wrap ai_backup in try-catch (non-fatal)
- [x] BaseContextBuilder: stable sort with secondary index key

### Phase 2: Auto-Save ✅ (#31)

- [x] `useAutoSave` hook: 3s debounce → `apiPut` directly (avoids cache overwrite)
- [x] State: `idle | saving | saved | error`
- [x] `autoSaveStatus` in editor store
- [x] Auto-save indicator in toolbar (pulsing dot + status label)

### Phase 3: Prompt Presets ✅ (#32)

- [x] `presets.ts`: 16 presets across 4 categories (pacing/style/content/character)
- [x] `PromptPresets.tsx`: category filter tabs + scrollable chip bar
- [x] Click chip → append to promptText in AISidebar

### Phase 4: Outline Editing ✅ (#33)

- [x] `OutlinePanel.tsx`: collapsible panel above editor
- [x] Fields: goal (text), scenes (add/remove list), hookEnding (text)
- [x] Auto-save outline changes (1.5s debounced `useUpdateChapter`)

### Phase 5: Brainstorm Redesign ✅ (#37)

- [x] `parseBrainstorm.ts`: parse AI response → suggestion cards
- [x] `BrainstormPanel.tsx`: card grid with Use/Regenerate/Dismiss actions
- [x] Restore Brainstorm button in AISidebar
- [x] 7 unit tests for parser

### Phase 6: Tech Debt + Testing ✅ (#2, #3, #6, #42)

- [x] `BaseRepository.parseJson`: optional Zod schema param for runtime validation
- [x] Type assertions audited — all justified, no unsafe casts
- [x] Error module: 29 tests covering all 9 error classes + type guards + helpers
- [x] `mergeContent` utility extracted from AcceptPreviewModal
- [x] CSS tokens: hardcoded rgba → `var(--color-success-bg)`, z-index → `var(--z-base)`
- [x] E2E tests: chapter ordering, auto-save, outline (7 tests)

### Phase 7: Code Review Fixes (from comprehensive review)

**Must Fix**
- [ ] useAutoSave race condition: capture `chapterId` at debounce start, not setTimeout fire

**Should Fix — Auto-Save**
- [ ] `notifyManualSave()` should clear pending debounce timer
- [ ] Add AbortController for in-flight save requests on chapter switch/unmount
- [ ] Add `useAutoSave` unit tests

**Should Fix — Presets**
- [ ] i18n: 36 hardcoded English strings → `t('key')`
- [ ] Chip background: hardcoded `rgba` → design token
- [ ] Add preset data integrity tests (unique IDs, valid categories)
- [ ] Add `aria-pressed` on category toggle buttons

**Should Fix — Outline**
- [ ] Hardcoded `#ef4444` → `var(--color-danger)` in OutlinePanel.module.css
- [ ] Add `aria-expanded` on collapsible header
- [ ] Add save status indicator for outline changes

**Should Fix — Brainstorm**
- [ ] Remove redundant `chapterId` guard in AISidebar handleBrainstorm
- [ ] Add loading state in BrainstormPanel during regeneration
- [ ] Add parser test cases: en-dash separator, mixed formats

**Should Fix — Docs & Tests**
- [ ] Update Schema.md with `sort_order` column
- [ ] Strengthen reorderChapters E2E test (verify actual sort order, not just "doesn't throw")
- [ ] Define `--color-success-bg` in tokens.css (currently inline fallback only)

**Nits**
- [ ] Add inline comments to parseBrainstorm regex
- [ ] Consider dev-mode logging for parseJson Zod validation failures

---

## Verification

After all phases:
1. `pnpm typecheck` — 0 errors
2. `pnpm test` — all passing
3. `pnpm build` — clean
4. Manual: write → stop typing → auto-save indicator appears
5. Manual: click prompt preset chip → instruction populates → Continue uses it
6. Manual: open outline panel → fill goal + scenes → Continue → verify AI uses outline
7. Manual: click brainstorm → suggestion cards → select one → triggers Continue
8. Manual: reorder chapters → Continue → verify prev-chapter tail is correct
