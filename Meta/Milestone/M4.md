# Milestone 4: Search & Quality

- **Status**: Draft
- **Target Date**: 2026-04-25
- **Owner**: Wayne
- **Duration**: 2 weeks
- **Dependencies**: M3 (Writing Workspace)

## Goal

Implement **Search** and **Quality Control** features. Users can search across their entire project and receive real-time quality feedback on their writing.

## Success Criteria

After M4, users should be able to:

```
✓ Full-text search across all project content
✓ Semantic search using embeddings
✓ Get consistency warnings when writing conflicts with Story Bible
✓ See quality metrics and suggestions
✓ Run pre-defined quality checks
```

## Scope

### In Scope

1. **Search Service (P0/P1)**
   - Full-text search (SQLite FTS5)
   - Semantic search (embeddings with sqlite-vec)
   - Search results ranking
   - Search across: chapters, characters, world, notes

2. **Quality Service (P1/P2)**
   - Consistency checking (character details, world rules)
   - Basic Wayne Principles checking
   - Pacing analysis (basic)
   - Repetition detection

3. **Embeddings Infrastructure**
   - Embedding generation (Gemini embeddings API)
   - Vector storage (sqlite-vec)
   - Incremental embedding updates

4. **UI Components**
   - Global search modal
   - Quality panel in editor
   - Check results display

### Out of Scope

- Advanced pacing visualizer (future)
- Custom rule creation (future)
- Multi-language support

## Deliverables

| # | Deliverable | Acceptance Criteria |
|---|-------------|---------------------|
| 1 | **SearchService Implementation** | FTS + semantic search working |
| 2 | **QualityService Implementation** | Consistency checks running |
| 3 | **Embeddings Pipeline** | Auto-embed on content change |
| 4 | **Global Search UI** | Cmd+K search modal |
| 5 | **Quality Panel** | Real-time quality feedback |
| 6 | **CLI Commands** | `inxtone check` command |

---

## Tasks

### Phase 1: Search Infrastructure (Day 1-4)

- [ ] Implement `SearchRepository`
  - [ ] FTS5 query builder
  - [ ] Multi-table search
  - [ ] Result ranking
  - [ ] Highlighting
- [ ] Implement `SearchService`
  - [ ] Full-text search
  - [ ] Filter by entity type
  - [ ] Recent searches
- [ ] Create `/api/search` endpoints
  - [ ] GET /api/search?q=&type=&limit=
  - [ ] GET /api/search/suggest (autocomplete)
- [ ] Write search tests

### Phase 2: Embeddings System (Day 5-7)

- [ ] Set up sqlite-vec extension
- [ ] Implement `EmbeddingService`
  - [ ] Generate embeddings via Gemini API
  - [ ] Store in embeddings table
  - [ ] Batch processing
  - [ ] Incremental updates
- [ ] Implement semantic search
  - [ ] Vector similarity query
  - [ ] Hybrid ranking (FTS + semantic)
- [ ] Background embedding job
  - [ ] Queue system for embedding generation
  - [ ] Rate limiting
  - [ ] Progress tracking

### Phase 3: Quality Service (Day 8-11)

- [ ] Implement `QualityRepository`
  - [ ] Store check results
  - [ ] Query historical checks
- [ ] Implement `QualityService`
  - [ ] Character consistency check
    - [ ] Name consistency
    - [ ] Appearance consistency
    - [ ] Personality consistency
  - [ ] World rule consistency check
  - [ ] Basic Wayne Principles check
  - [ ] Repetition detection
  - [ ] Pacing analysis (basic)
- [ ] Create `/api/quality` endpoints
  - [ ] POST /api/quality/check - run checks
  - [ ] GET /api/quality/results/:chapterId
  - [ ] GET /api/quality/summary
- [ ] Rule engine foundation
  - [ ] Define rule format
  - [ ] Built-in rules
  - [ ] Rule execution

### Phase 4: UI Components (Day 12-13)

- [ ] **Global Search Modal**
  - [ ] Cmd+K activation
  - [ ] Type-ahead suggestions
  - [ ] Result preview
  - [ ] Navigate to result
  - [ ] Filter by type
- [ ] **Quality Panel**
  - [ ] Issues list
  - [ ] Severity indicators
  - [ ] Jump to issue location
  - [ ] Dismiss/acknowledge
- [ ] **Quality Dashboard**
  - [ ] Overall quality score
  - [ ] Check history
  - [ ] Common issues

### Phase 5: CLI & Testing (Day 14)

- [ ] Implement `inxtone check [chapter]`
  - [ ] Run all checks
  - [ ] Output results
  - [ ] Exit code for CI
- [ ] Implement `inxtone search <query>`
- [ ] End-to-end tests
- [ ] Performance testing
  - [ ] Search with 1000+ documents
  - [ ] Embedding generation speed

---

## Test Plan

### Unit Tests
- [ ] FTS query building
- [ ] Embedding vector operations
- [ ] Quality rule execution

### Integration Tests
- [ ] Search + FTS5
- [ ] Embeddings + Gemini API
- [ ] Quality checks against test data

### E2E Tests
- [ ] Search → find character → navigate
- [ ] Write inconsistent content → quality warning
- [ ] CLI check → see results

---

## Technical Notes

### Search Architecture

```
User Query
    ↓
┌──────────────────────────────────────┐
│  Query Parser                        │
│  - Tokenize                          │
│  - Detect entity hints               │
└──────────────────────────────────────┘
    ↓                    ↓
┌──────────┐      ┌──────────────┐
│ FTS5     │      │ Semantic     │
│ Search   │      │ Search       │
└──────────┘      └──────────────┘
    ↓                    ↓
┌──────────────────────────────────────┐
│  Result Ranker                       │
│  - Combine scores                    │
│  - Boost exact matches               │
│  - Apply filters                     │
└──────────────────────────────────────┘
    ↓
Search Results
```

### Quality Check Format

```typescript
interface CheckResult {
  id: string;
  type: 'consistency' | 'repetition' | 'pacing' | 'rule';
  severity: 'error' | 'warning' | 'info';
  message: string;
  location?: {
    chapterId: ChapterId;
    startOffset: number;
    endOffset: number;
  };
  suggestion?: string;
  relatedEntities?: Array<{
    type: 'character' | 'location' | 'world';
    id: string;
    name: string;
  }>;
}
```

### Embedding Strategy

```typescript
// What gets embedded
const embeddableContent = [
  { type: 'chapter', fields: ['content', 'outline'] },
  { type: 'character', fields: ['name', 'appearance', 'motivation'] },
  { type: 'world', fields: ['rules', 'powerSystem'] },
  { type: 'location', fields: ['name', 'description'] },
];

// Chunk strategy for long content
const CHUNK_SIZE = 500; // tokens
const CHUNK_OVERLAP = 50; // tokens
```

---

## Dependencies

- M3 must be complete (AI service for embeddings)
- sqlite-vec extension available

## Risks

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Embedding API costs | Medium | Medium | Batch processing, caching |
| sqlite-vec compatibility | Low | High | Test early, fallback to FTS only |
| False positives in quality checks | High | Medium | Tunable thresholds, dismiss option |
| Search performance | Medium | Medium | Proper indexing, pagination |

---

## Notes

- **核心价值**: Search + Quality 让长篇小说的一致性管理成为可能
- FTS5 triggers 已在 M1 schema 中创建
- sqlite-vec 需要编译安装，可能需要 fallback 方案
- 质量检查初期可以简单，后续迭代增强
- 考虑质量检查结果的缓存策略
