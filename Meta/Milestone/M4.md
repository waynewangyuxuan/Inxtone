# Milestone 4: AI Quality + Writing UX

- **Status**: In Progress
- **Target Date**: 2026-02-20
- **Owner**: Wayne
- **Duration**: 10 days
- **Dependencies**: M3 (Writing Workspace)

## Goal

Close remaining AI quality bugs, deliver writing UX features users need, and address high-priority tech debt. FTS/semantic search and QualityService deferred to M5.

## Success Criteria

```
✓ Chapter ordering works correctly (sort_order, not creation ID)
✓ Auto-save prevents data loss during writing sessions
✓ Prompt presets provide quick AI instruction chips
✓ Chapter outlines are editable in the UI
✓ Brainstorm mode returns selectable suggestion cards
✓ Code review issues addressed (8 critical/high fixes)
✓ All 17 GitHub issues closed
```

## Scope

### In Scope

1. **AI Quality Bug** — Chapter ordering (#25)
2. **Auto-save** — Debounced save without version creation (#31)
3. **Prompt Presets** — Clickable instruction chips (#32)
4. **Outline Editing** — UI for chapter goal/scenes/hookEnding (#33)
5. **Brainstorm Redesign** — Selectable suggestion cards (#37)
6. **Tech Debt** — JSON parsing safety (#2), type assertions (#3), error tests (#6), PR review fixes (#42)
7. **Code Review Fixes** — 8 critical/high issues from comprehensive review

### Out of Scope (Deferred to M5)

- FTS5 search + Cmd+K modal
- Semantic search / embeddings (sqlite-vec)
- QualityService + quality panel
- CLI `inxtone check`
- Auto-suggest entity links (#28)
- Interactive StoryBiblePanel (#34)
- Version history + volume switcher (#35)

## Issue Mapping

| Phase | Closes | Count |
|-------|--------|-------|
| Pre-Phase | #20, #21, #22, #23, #24, #26, #27, #29 | 8 |
| Phase 1 | #25 | 1 |
| Phase 2 | #31 | 1 |
| Phase 3 | #32 | 1 |
| Phase 4 | #33 | 1 |
| Phase 5 | #37 | 1 |
| Phase 6 | #2, #3, #6, #42 | 4 |
| **Total** | | **17** |

---

## Tasks

### Pre-Phase: Close Already-Fixed Issues ✅

Issues #20-24, #26-27, #29 were already fixed in the codebase during M3 development. Closed with code references.

### Phase 1: Chapter Ordering ✅ (#25)

- [x] Migration 002: `sort_order INTEGER` column + backfill + composite index
- [x] Update `WritingRepository`: all queries use `ORDER BY sort_order ASC, id ASC`
- [x] `createChapter()`: auto-assign `MAX(sort_order) + 1` within volume
- [x] Real `reorderChapters()`: updates sort_order by array position
- [x] Add `sortOrder: number` to Chapter entity type
- [x] Tests: 1016 passing, typecheck clean

### Code Review Fixes ✅

- [x] ChapterListPanel: sort by `sortOrder` (not `id`)
- [x] ChapterListPanel: defer selection clear to delete `onSuccess`
- [x] ContextPreview: consistent ID fallback (`idx-N`) in count + render
- [x] AcceptPreviewModal: ensure exactly `\n\n` paragraph breaks
- [x] StreamingResponse: only auto-scroll when near bottom
- [x] AISidebar: abort stream on chapter switch (prevents wrong-chapter accept)
- [x] AIService: wrap ai_backup in try-catch (non-fatal)
- [x] BaseContextBuilder: stable sort with secondary index key

### Phase 2: Auto-Save (#31)

- [ ] `useAutoSave` hook: 3s debounce → `saveContent({ createVersion: false })`
- [ ] State: `idle | saving | saved | error`
- [ ] Cancel on chapter switch / unmount
- [ ] `autoSaveStatus` in editor store
- [ ] Auto-save indicator in toolbar

### Phase 3: Prompt Presets (#32)

- [ ] `packages/core/src/ai/presets.ts`: preset type + ~15 presets across 4 categories
- [ ] `PromptPresets.tsx`: horizontal scrollable chip bar
- [ ] Click chip → append to promptText in AISidebar

### Phase 4: Outline Editing (#33)

- [ ] `OutlinePanel.tsx`: collapsible panel above editor
- [ ] Fields: goal (text), scenes (sortable list), hookEnding (text)
- [ ] Auto-save outline changes (debounced `useUpdateChapter`)

### Phase 5: Brainstorm Redesign (#37)

- [ ] `parseBrainstorm.ts`: parse AI response → suggestion cards
- [ ] `BrainstormPanel.tsx`: card grid with "Use as instruction" + "Regenerate"
- [ ] Restore Brainstorm button in AISidebar
- [ ] `brainstormSuggestions` in editor store

### Phase 6: Tech Debt + Testing (#2, #3, #6, #42)

- [ ] JSON parsing: replace raw `JSON.parse()` with Zod schemas in repo layer
- [ ] Type assertions: audit `as` casts, replace with narrowing
- [ ] Error module tests
- [ ] E2E tests for auto-save, chapter ordering, outline
- [ ] Update Progress.md, CHANGELOG.md

---

## Verification

After all phases:
1. `pnpm typecheck` — 0 errors
2. `pnpm test` — all passing
3. `pnpm build` — clean
4. Manual: write → stop typing → auto-save indicator appears
5. Manual: click prompt preset chip → instruction populates → Continue uses it
6. Manual: open outline panel → fill goal + scenes → Continue → verify AI uses outline
7. Manual: click brainstorm → suggestion cards → select one → triggers Continue
8. Manual: reorder chapters → Continue → verify prev-chapter tail is correct
