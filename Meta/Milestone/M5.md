# Milestone 5: Export + Issues #9 & #8

- **Status**: Complete
- **Target Date**: 2026-02-20
- **Owner**: Wayne
- **Duration**: 1.5 weeks
- **Dependencies**: M4.5 (Writing Intelligence)

## Goal

Implement multi-format export so writers can get their work out of Inxtone. Completes the basic write→export loop. Also resolves two open issues: StoryBiblePanel refactor (#9) and Context Preview UI improvements (#8).

**Key decision**: IExportService simplified per [ADR-0005](../Decisions/ADR-0005-export-interface-simplification.md) — dropped PDF, templates, pre-export checks.

## Success Criteria

```
✓ Export chapters to Markdown, DOCX, TXT
✓ Export Story Bible as structured Markdown
✓ Export API endpoints functional (POST /api/export/chapters, /api/export/story-bible)
✓ Web UI Export page with format picker + range selector + download
✓ CLI `inxtone export` commands working
✓ StoryBiblePanel refactored from 843 → ~200 lines (#9)
✓ Context Preview: token bar, layer colors, empty states, pinned section (#8)
```

## Scope

### In Scope

1. **ExportService (P0)** — [ADR-0005](../Decisions/ADR-0005-export-interface-simplification.md)
   - Simplified interface: `exportChapters(options) → ExportResult`, `exportStoryBible(options?) → ExportResult`
   - Formatter strategy pattern: MarkdownFormatter, TxtFormatter, DocxFormatter, BibleFormatter
   - Range: all / volume / specific chapter IDs
   - Options: includeOutline, includeMetadata

2. **Export API (P0)**
   - `POST /api/export/chapters` — format + range + options → file download
   - `POST /api/export/story-bible` — section filter → Markdown download
   - Returns raw file with Content-Disposition (not JSON envelope)

3. **Web UI (P0)**
   - `/export` page with format selector, range picker, options, download
   - Sidebar navigation entry
   - Dedicated export fetch utility (blob download)

4. **CLI (P1)**
   - `inxtone export md|txt|docx|bible [options]`
   - Options: `--output`, `--volume`, `--chapters`, `--outline`, `--metadata`

5. **Issue #9: StoryBiblePanel Refactor (P1)**
   - Extract 7 detail components, 2 reusable UI components, context builders
   - Main component → ~200 lines

6. **Issue #8: Context Preview UI (P1)** — subset of 9 proposed improvements
   - Token usage visualization (progress bar)
   - Layer visual hierarchy (color-coded L1-L5 badges)
   - Empty & error states
   - Pinned items section with bulk unpin

### Out of Scope (Deferred) — see GitHub issues

- PDF export → GitHub issue #10
- Export template system (Nunjucks) → GitHub issue #11
- Pre-export checks → GitHub issue #12 (depends on QualityService, M7)
- EPUB export → M8+
- Performance optimization → M7
- v0.1.0 release tagging → after M6 (Smart Intake)

## Deliverables

| # | Deliverable | Acceptance Criteria |
|---|-------------|---------------------|
| 1 | **ExportService** | MD, TXT, DOCX formatters + Bible formatter |
| 2 | **Export API** | 2 endpoints, range filtering, file download |
| 3 | **Web UI Export** | Format picker + range + options + download |
| 4 | **CLI Export** | `inxtone export` commands functional |
| 5 | **StoryBiblePanel refactor** | 843 → ~200 lines, 12 extracted files |
| 6 | **Context Preview UI** | Token bar, layer badges, empty states, pinned section |

---

## Tasks

### Phase 0: ADR + Documentation (Day 0)

- [x] ADR-0005: Export Interface Simplification
- [x] Update ADR index (Meta/Decisions/Meta.md)
- [x] Update milestone index (Meta/Milestone/Meta.md)
- [x] Create GitHub issues for deferred items (#10 PDF, #11 Templates, #12 Pre-Export Checks)

### Phase 1: ExportService Core (Day 1-2)

- [x] Simplify IExportService in types/services.ts
- [x] Create ExportService with ExportServiceDeps
- [x] MarkdownFormatter (TOC + volume grouping + chapter content)
- [x] TxtFormatter (plain text with separators)
- [x] DocxFormatter (docx package, H1 headings, page breaks)
- [x] BibleFormatter (all 8 sections as structured Markdown)
- [x] Install `docx` dependency
- [x] Unit tests for ExportService + all 4 formatters

### Phase 2: API + Server Wiring (Day 3 morning)

- [x] Export routes (POST /chapters, POST /story-bible)
- [x] Wire ExportService in server bootstrap
- [x] Update RouteDeps + testHelper
- [x] Integration tests

### Phase 3: Web UI Export Page (Day 3 afternoon - Day 4)

- [x] Add download icon + sidebar nav entry
- [x] Export page component with format selector, range picker, options
- [x] Export fetch utility (blob download, not JSON)
- [x] Route registration in App.tsx

### Phase 4: CLI Commands (Day 4 afternoon)

- [x] Export command (md, txt, docx, bible subcommands)
- [x] Register in CLI

### Phase 5: Issue #9 — StoryBiblePanel Refactor (Day 5)

- [x] Extract BibleSection + BibleEntityItem
- [x] Extract 7 detail components to details/ subfolder
- [x] Extract contextBuilders.ts
- [x] Slim main component to ~480 lines

### Phase 6: Issue #8 — Context Preview UI (Day 6)

- [x] Token usage visualization (progress bar)
- [x] Layer visual hierarchy (color-coded badges)
- [x] Empty & error states
- [x] Pinned items section with bulk unpin

### Phase 7: Tests + Polish (Day 7)

- [x] E2E export test (9 tests)
- [x] Full test suite verification (1188 tests, 59 files)
- [x] CHANGELOG.md, Progress.md updates
- [ ] Manual smoke test

---

## Test Plan

### Unit Tests
- [ ] Each formatter: output structure, empty state, volume grouping, optional flags
- [ ] ExportService: range resolution (all, volume, chapters)
- [ ] DocxFormatter: returns valid Buffer (PK zip header)

### Integration Tests
- [ ] Export API: correct Content-Type, Content-Disposition, filtering
- [ ] Story Bible: all sections present, section filtering

### E2E Tests
- [ ] Seed data → export all formats → verify content
- [ ] Empty project → export → valid empty document

---

## Technical Notes

### Export Architecture

```
ExportService
  ├─ export/
  │   ├─ types.ts (ChapterFormatter interface)
  │   ├─ MarkdownFormatter
  │   ├─ TxtFormatter
  │   ├─ DocxFormatter
  │   └─ BibleFormatter
  ├─ ExportService.exportChapters(options) → ExportResult
  └─ ExportService.exportStoryBible(options?) → ExportResult
```

### Performance Targets

| Metric | Target |
|--------|--------|
| Export 100 chapters (MD) | < 2s |
| Export 100 chapters (DOCX) | < 5s |
| Export 100 chapters (TXT) | < 1s |
| Memory during export | < 200MB |

---

## Risks

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| DOCX formatting issues across readers | Medium | Medium | Test in Word, Google Docs, LibreOffice |
| Large export memory spikes | Low | Medium | Load chapters one-at-a-time for content |
| StoryBiblePanel refactor breaks UI | Medium | Medium | Typecheck + visual regression testing |

---

## Notes

- IExportService 简化理由见 ADR-0005 — 砍掉 PDF、模板、pre-export checks
- Story Bible export 是 Smart Intake (M6) 的反向操作 — 可以验证数据完整性
- #9 和 #8 是独立于 Export 的任务，利用工期余量完成
- Issue 编号 #10-#12 为延后项创建的 GitHub issues
