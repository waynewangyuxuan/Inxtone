# Milestone 5: Export

- **Status**: Draft
- **Target Date**: TBD (after M4.5)
- **Owner**: Wayne
- **Duration**: 1.5 weeks
- **Dependencies**: M4.5 (Writing Intelligence)

## Goal

Implement multi-format export so writers can get their work out of Inxtone. Completes the basic write→export loop. Deliberately kept small and focused — polish, docs, and CLI enhancements move to later milestones.

## Success Criteria

```
✓ Export chapters to Markdown, DOCX, TXT
✓ Export Story Bible as structured document
✓ Export API endpoints functional
✓ Web UI export controls working
✓ CLI `inxtone export` command working
```

## Scope

### In Scope

1. **ExportService (P0)**
   - Markdown export (chapters + front matter + TOC)
   - DOCX export (chapter headings, page breaks, proper formatting)
   - TXT export (plain text, chapter separators)
   - Story Bible export (character summaries, world rules, plot outline)

2. **Export API (P0)**
   - `POST /api/export/markdown`
   - `POST /api/export/docx`
   - `POST /api/export/txt`
   - `POST /api/export/story-bible`
   - Options: chapter range, include outline, include Story Bible

3. **Web UI (P0)**
   - Export button in toolbar/sidebar
   - Format selector (MD / DOCX / TXT / Bible)
   - Chapter range picker (all / volume / custom range)
   - Download trigger

4. **CLI (P1)**
   - `inxtone export md [output]`
   - `inxtone export docx [output]`
   - `inxtone export txt [output]`
   - `inxtone export bible [output]`
   - Options: `--chapters`, `--include-outline`

### Out of Scope (Deferred)

- EPUB export → M8+
- PDF export → M8+
- Export templates / custom styling → M8+
- Performance optimization → M7
- Full documentation / README rewrite → M7
- CLI polish (config, completion, help text) → M7
- Accessibility audit → M7
- v0.1.0 release tagging → after M6 (Smart Intake)

## Deliverables

| # | Deliverable | Acceptance Criteria |
|---|-------------|---------------------|
| 1 | **ExportService** | All 4 formats generate correct output |
| 2 | **Export API** | 4 endpoints, chapter range filtering works |
| 3 | **Web UI Export** | Format picker + chapter range + download |
| 4 | **CLI Export** | `inxtone export` commands functional |

---

## Tasks

### Phase 1: ExportService Core (Day 1-4)

- [ ] Implement `ExportService` interface
- [ ] Markdown export
  - [ ] Chapter content with front matter (title, word count, date)
  - [ ] Table of contents generation
  - [ ] Volume separators
- [ ] DOCX export
  - [ ] Use `docx` library
  - [ ] Chapter headings (H1)
  - [ ] Page breaks between chapters
  - [ ] Basic styling (font, spacing)
- [ ] TXT export
  - [ ] Plain text with chapter separators
  - [ ] Optional: include chapter titles
- [ ] Story Bible export
  - [ ] Character summaries (name, role, motivation, arc status)
  - [ ] World rules overview
  - [ ] Relationship summary
  - [ ] Plot outline (arcs, sections, foreshadowing status)
  - [ ] Output as Markdown document
- [ ] Tests: each format generates correctly, round-trip verification

### Phase 2: API + UI + CLI (Day 4-8)

- [ ] Create export API routes
  - [ ] `POST /api/export/:format` — unified endpoint with format param
  - [ ] Request body: `{ format, chapterRange?, includeOutline?, includeBible? }`
  - [ ] Response: file download (Content-Disposition header)
- [ ] Web UI export controls
  - [ ] Export button in sidebar or toolbar
  - [ ] Export modal: format selector, chapter range, options
  - [ ] Download trigger on completion
- [ ] CLI commands
  - [ ] `inxtone export` with format and output path args
  - [ ] Progress indicator for large exports
- [ ] Tests: API returns correct file types, UI triggers download

### Phase 3: Polish + Edge Cases (Day 8-10)

- [ ] Handle large exports (100+ chapters)
  - [ ] Streaming DOCX generation if needed
  - [ ] Memory usage check
- [ ] Empty state handling (no chapters, no Bible data)
- [ ] Error messages for partial exports (some chapters missing content)
- [ ] Update CHANGELOG.md

---

## Test Plan

### Unit Tests
- [ ] Markdown generation: TOC, front matter, content formatting
- [ ] DOCX generation: document structure, headings, page breaks
- [ ] TXT generation: separators, encoding
- [ ] Story Bible export: all entity types included

### Integration Tests
- [ ] Full export pipeline: query chapters → generate → return file
- [ ] Chapter range filtering: single chapter, volume, custom range
- [ ] Large project export (100+ chapters, performance check)

---

## Technical Notes

### Export Architecture

```
ExportService
  ├─ formatters/
  │   ├─ MarkdownFormatter
  │   ├─ DocxFormatter
  │   ├─ TxtFormatter
  │   └─ BibleFormatter
  ├─ ExportService.export(options) → Buffer | string
  └─ Used by: API routes + CLI commands
```

### DOCX Generation

```typescript
import { Document, Paragraph, HeadingLevel, PageBreak } from 'docx';
```

### Performance Targets

| Metric | Target |
|--------|--------|
| Export 100 chapters (MD) | < 2s |
| Export 100 chapters (DOCX) | < 5s |
| Export 100 chapters (TXT) | < 1s |
| Memory during export | < 200MB |

---

## Risks

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| DOCX formatting issues across readers | Medium | Medium | Test in Word, Google Docs, LibreOffice |
| Large export memory spikes | Low | Medium | Stream generation, chunk processing |

---

## Notes

- 故意缩小 scope：Export 是一个快速、确定性高的 milestone，不应该被 polish/docs 拖慢
- MVP release (v0.1.0) 推迟到 M6 (Smart Intake) 之后 — 没有 intake 的 MVP 不具备真实采用能力
- Story Bible export 本身也是 Smart Intake (M6) 的反向操作 — 可以验证数据完整性
