# Milestone 4.5: Writing Intelligence

- **Status**: Complete âœ…
- **Completed**: 2026-02-12
- **Owner**: Wayne
- **Duration**: 2 days (2026-02-11 â€“ 2026-02-12)
- **Dependencies**: M4 (Writing UX)

## Goal

Make the writing workspace *intelligent* â€” the Bible panel becomes a live co-pilot, search makes content discoverable, and AI-generated text feeds back into the Story Bible automatically. After M4.5, writing in Inxtone feels like writing *with a partner who remembers everything*.

**Product pivot**: Inxtone focuses on **writing from scratch** (not importing existing long works). Intake scenarios assume the writer is passing in outlines, character designs, and world designs â€” not 1000-chapter backlogs.

## Success Criteria

```
âœ… Cmd+K search modal with instant full-text results across all entities
âœ… Interactive Bible panel shows entity details, supports inject-to-context
â³ Relationship map visualization (force-directed graph) â†’ Deferred to GitHub Issue #4
â³ Timeline visualization (chronological event display) â†’ Deferred to GitHub Issue #5
â³ Pacing visualization (word count / emotion curve per chapter) â†’ Deferred to GitHub Issue #6
âœ… Chapter setup assist auto-suggests relevant entities from outline + arc
âœ… Post-accept extraction: AI-generated text â†’ new/mentioned entities detected
âœ… Keyboard shortcut system covers all frequent actions
```

## Scope

### In Scope

1. **Full-Text Search + Cmd+K (P0)**
   - FTS5 virtual table across characters, chapters, world, arcs, foreshadowing
   - Cmd+K modal: instant search-as-you-type (debounced)
   - Results grouped by entity type with snippets
   - Click result â†’ navigate to entity detail
   - Issue #28 partial (search infrastructure)

2. **Interactive Bible Panel (P0)** â€” Issue #34
   - Click entity â†’ expand inline detail (full profile, not just name + badge)
   - Entity sections: characters, relationships, world, locations, factions, arcs, foreshadowing, hooks
   - "Inject to context" button: pin entity for next AI generation
   - Quick-search within panel
   - Contextual: highlight entities relevant to current chapter

3. **Relationship Map (P0)**
   - Force-directed graph visualization (D3 or similar)
   - Nodes = characters, edges = relationships
   - Edge labels: relationship type + dynamic
   - Click node â†’ Bible panel scrolls to character
   - Filter by: arc involvement, faction, relationship type

4. **Timeline Visualization (P0)**
   - Chronological display of timeline events
   - Events linked to chapters, characters, locations
   - Visual markers for arc boundaries
   - Click event â†’ navigate to chapter/entity

5. **Pacing Visualization (P0)**
   - Word count per chapter (bar chart)
   - Emotion/intensity curve across chapters (line chart)
   - Golden chapter markers (high-stakes chapters from outline)
   - Visual chapter-type distribution (action / dialogue / introspection)

6. **Chapter Setup Assist (P0)** â€” Heuristic Layer
   - On new chapter creation:
     - Parse chapter outline â†’ extract mentioned character names
     - Carry over characters from previous chapter
     - Pull characters assigned to current arc
     - Auto-suggest locations from outline keywords
   - Suggested entities shown as chips: one-click to attach to chapter
   - "Add more" link opens Bible panel search
   - No AI calls â€” pure heuristic (name matching, FK lookups)

7. **Post-Accept Entity Extraction (P1)** â€” AI Layer
   - After user accepts AI-generated text:
     - Async background call: `POST /api/intake/extract-entities`
     - Gemini analyzes accepted text against existing Bible
     - Returns: `{ mentioned: EntityRef[], new: NewEntitySuggestion[] }`
   - Sidebar notification: "2 new entities detected"
   - Review mini-panel: confirm / edit / dismiss each entity
   - Confirmed entities written to Story Bible + linked to chapter
   - Non-blocking: extraction failure doesn't affect writing flow

8. **Keyboard Shortcuts (P1)**
   - Cmd+K: search modal
   - Cmd+Enter: send to AI
   - Cmd+Shift+B: toggle Bible panel
   - Cmd+Shift+O: toggle outline panel
   - Cmd+S: manual save
   - Shortcut reference modal (Cmd+/)
   - Shortcuts configurable in settings (stretch)

### Out of Scope

- Semantic search / sqlite-vec embeddings â†’ M7
- QualityService / consistency rules â†’ M7
- Version history + diff viewer â†’ M7
- CLI commands (search, check, config) â†’ M7
- Ambient entity detection during writing â†’ M8+
- Full chapter import + auto-extraction â†’ M6
- Performance optimization / docs / release â†’ M7

## Deliverables

| # | Deliverable | Acceptance Criteria |
|---|-------------|---------------------|
| 1 | **FTS5 Search + Cmd+K** | Search returns results across all entity types, < 100ms latency |
| 2 | **Interactive Bible Panel** | Click-to-expand, inject-to-context, all 8 entity sections |
| 3 | **Relationship Map** | Force-directed graph renders, click navigates, filters work |
| 4 | **Timeline Visualization** | Events display chronologically, linked to chapters/entities |
| 5 | **Pacing Visualization** | Word count bars + emotion curve + golden chapter markers |
| 6 | **Chapter Setup Assist** | Auto-suggests entities for new chapters, one-click attach |
| 7 | **Post-Accept Extraction** | AI detects entities from accepted text, review â†’ commit flow |
| 8 | **Keyboard Shortcuts** | All shortcuts work, reference modal accessible |

---

## Tasks

### Phase 1: Search Infrastructure (Day 1-3)

- [ ] FTS5 virtual table migration
  - [ ] Index: characters (name, appearance, motivation), chapters (title, content), world, locations, factions, arcs, foreshadowing
  - [ ] Triggers for auto-update on insert/update/delete
- [ ] SearchService implementation
  - [ ] `search(query, options?)` â€” FTS5 query with BM25 ranking
  - [ ] Results grouped by entity type
  - [ ] Highlight matching snippets (FTS5 `highlight()` function)
- [ ] Cmd+K search modal component
  - [ ] Keyboard shortcut trigger (Cmd+K / Ctrl+K)
  - [ ] Instant search-as-you-type (300ms debounce)
  - [ ] Result cards: entity type icon, name, snippet
  - [ ] Arrow key navigation + Enter to select
  - [ ] Click/Enter â†’ navigate to entity detail or chapter
- [ ] API: `GET /api/search?q=<query>&type=<entityType>`
- [ ] Tests: FTS5 indexing correctness, search ranking, snippet generation

### Phase 2: Interactive Bible Panel (Day 2-5)

- [ ] Redesign `StoryBiblePanel.tsx`
  - [ ] 8 collapsible sections (characters, relationships, world, locations, factions, arcs, foreshadowing, hooks)
  - [ ] Each entity: click to expand inline detail card
  - [ ] Detail card shows full entity profile (reuse Story Bible detail components)
  - [ ] "Inject to context" button per entity (pins for next AI generation)
  - [ ] Visual indicator for injected entities (highlighted/starred)
- [ ] Contextual relevance
  - [ ] Chapter FK arrays â†’ highlight "in this chapter" entities
  - [ ] Outline mentions â†’ highlight "in outline" entities
  - [ ] Sort: relevant entities first, then alphabetical
- [ ] Quick-search within panel (filter entities by name)
- [ ] Panel state persistence (expanded sections, scroll position)
- [ ] Tests: entity rendering, inject-to-context updates context builder, search filter

### Phase 3: Visualizations (Day 4-9)

#### Relationship Map (Day 4-6)

- [ ] Visualization component: `RelationshipMap.tsx`
  - [ ] Force-directed graph (D3-force or react-force-graph)
  - [ ] Nodes: character name, role badge, optional avatar
  - [ ] Edges: relationship type label, line style by dynamic (ally/rival/complex)
  - [ ] Color coding by faction or arc involvement
- [ ] Interactions
  - [ ] Hover node: highlight connected edges
  - [ ] Click node: open character detail in Bible panel
  - [ ] Zoom + pan + fit-to-screen
  - [ ] Filter controls: by arc, faction, relationship type
- [ ] Data source: `GET /api/bible/characters` + `GET /api/bible/relationships`
- [ ] Layout in Bible tab or dedicated "Map" tab in left sidebar

#### Timeline Visualization (Day 6-7)

- [ ] Visualization component: `TimelineView.tsx`
  - [ ] Horizontal or vertical chronological display
  - [ ] Event cards: title, date, linked characters, linked chapter
  - [ ] Arc boundary markers (colored bands or dividers)
  - [ ] Zoom levels: overview (all events) / arc-level / chapter-level
- [ ] Interactions
  - [ ] Click event â†’ navigate to linked chapter or entity
  - [ ] Hover: preview event details
  - [ ] Filter by arc, character involvement
- [ ] Data source: `GET /api/bible/timeline` + arc data
- [ ] Layout in Bible tab or dedicated "Timeline" tab

#### Pacing Visualization (Day 7-9)

- [ ] Visualization component: `PacingView.tsx`
  - [ ] Word count bar chart (per chapter, stacked by volume)
  - [ ] Emotion/intensity line chart overlay
  - [ ] Golden chapter markers (flagged in outline as high-stakes)
  - [ ] Chapter-type heatmap (action / dialogue / introspection â€” derived from outline tags or AI analysis)
- [ ] Interactions
  - [ ] Click chapter bar â†’ navigate to chapter
  - [ ] Hover: show word count, outline goal, emotion tag
  - [ ] Toggle between word count / emotion / combined views
- [ ] Data source: chapters (word count), outlines (emotion tags, golden flag)
- [ ] Layout in dedicated "Pacing" tab in left sidebar or Bible section

### Phase 4: Chapter Setup Assist (Day 8-11)

- [ ] `ChapterSetupAssist.tsx` component
  - [ ] Trigger: shown when creating new chapter or when chapter has no linked entities
  - [ ] Three heuristic sources:
    - [ ] **Outline parse**: regex match character names, location names from chapter outline text
    - [ ] **Previous chapter carry-over**: entities linked to `chapter[N-1]`
    - [ ] **Arc roster**: characters assigned to current arc's character list
  - [ ] Deduplicate across sources, rank by relevance (outline mention > carry-over > arc)
- [ ] Suggestion UI
  - [ ] Entity chips with source indicator (ğŸ“ outline / â¬…ï¸ prev chapter / ğŸ­ arc)
  - [ ] One-click to attach entity to chapter (updates chapter FK arrays)
  - [ ] "Dismiss" to hide suggestion
  - [ ] "Add more" â†’ opens Bible panel search
- [ ] Integrate into chapter creation flow
  - [ ] Show after chapter title is set and outline is filled
  - [ ] Also accessible from Bible panel header ("Setup Assist" button)
- [ ] Tests: heuristic extraction accuracy, chip actions, FK update correctness

### Phase 5: Post-Accept Entity Extraction (Day 10-13)

- [ ] `EntityExtractionService` implementation
  - [ ] `extractEntities(text: string, chapterId: string): ExtractionResult`
  - [ ] Gemini prompt: "Given this chapter text and existing Story Bible, identify mentioned entities and any new entities"
  - [ ] Input: accepted text + existing character/location/faction names (for matching)
  - [ ] Output: `{ mentioned: { type, id, confidence }[], new: { type, name, description, confidence }[] }`
  - [ ] Schema validation with Zod
- [ ] Background extraction trigger
  - [ ] After user clicks "Accept" on AI-generated text
  - [ ] Async call â€” does not block writing
  - [ ] Store extraction result in memory (not persisted until user confirms)
  - [ ] Retry once on failure, then silently drop
- [ ] Review UI
  - [ ] Sidebar notification badge: "3 entities detected"
  - [ ] `EntityReviewPanel.tsx`: expandable mini-panel
  - [ ] Mentioned entities: toggle link to chapter (default: auto-link)
  - [ ] New entities: preview card with "Create" / "Edit & Create" / "Dismiss"
  - [ ] "Create" writes entity to Story Bible via existing repos
  - [ ] Batch actions: "Link all mentioned" / "Dismiss all new"
- [ ] API: `POST /api/intake/extract-entities`
  - [ ] Request: `{ text, chapterId, existingEntityNames }`
  - [ ] Response: `{ mentioned, new, warnings }`
- [ ] Tests: extraction prompt returns valid schema, review actions update DB correctly

### Phase 6: Keyboard Shortcuts + Polish (Day 12-14)

- [ ] Keyboard shortcut system
  - [ ] `useKeyboardShortcuts` hook: global listener with context awareness
  - [ ] Shortcut registry: action â†’ key combo mapping
  - [ ] Cmd+K: search, Cmd+Enter: send to AI, Cmd+Shift+B: Bible, Cmd+Shift+O: outline, Cmd+S: save
  - [ ] Shortcut reference modal (Cmd+/)
- [ ] Integration polish
  - [ ] Bible panel â†” search: Cmd+K within Bible panel filters entities
  - [ ] Visualization tabs: smooth transitions, loading states
  - [ ] Chapter setup â†” Bible panel: "Add more" navigates correctly
  - [ ] Entity extraction â†” Bible panel: newly created entities appear immediately
- [ ] Visual polish
  - [ ] Loading states for all new components
  - [ ] Empty states (no relationships â†’ "Add relationships to see the map")
  - [ ] Error boundaries for visualization failures
  - [ ] Responsive layout for all new panels
- [ ] Tests: shortcut triggers, component error boundaries, empty states render

---

## Test Plan

### Unit Tests
- [ ] FTS5: index creation, query ranking, snippet generation
- [ ] SearchService: grouped results, entity type filtering
- [ ] Heuristic extraction: name matching from outline text
- [ ] Entity extraction prompt: valid JSON output for known inputs
- [ ] Keyboard shortcut hook: key combo detection, context blocking

### Integration Tests
- [ ] Search pipeline: create entities â†’ search â†’ verify results
- [ ] Bible panel: render all entity types, inject-to-context updates builder
- [ ] Chapter setup: create chapter with outline â†’ verify suggestions match
- [ ] Post-accept extraction: accept AI text â†’ extraction runs â†’ review â†’ commit â†’ verify in DB
- [ ] Shortcut system: trigger shortcut â†’ action fires

### E2E Tests
- [ ] Cmd+K â†’ type query â†’ select result â†’ navigated to entity
- [ ] New chapter â†’ outline filled â†’ setup assist shows relevant entities â†’ attach â†’ AI uses them
- [ ] AI generate â†’ accept â†’ extraction detects entities â†’ confirm â†’ entities in Bible
- [ ] Relationship map renders with demo data, click node â†’ Bible panel opens

---

## Technical Notes

### FTS5 Architecture

```sql
CREATE VIRTUAL TABLE search_index USING fts5(
  entity_type,
  entity_id UNINDEXED,
  name,
  content,
  tokenize = 'unicode61'
);

-- Triggers on each entity table:
-- INSERT â†’ insert into search_index
-- UPDATE â†’ update search_index
-- DELETE â†’ delete from search_index
```

### Chapter Setup Assist â€” Heuristic Pipeline

```
New Chapter Created
       â”‚
       â”œâ”€ Parse outline text â†’ regex match known entity names
       â”‚   (character names, location names from Bible)
       â”‚
       â”œâ”€ Previous chapter â†’ copy linked entity IDs
       â”‚
       â”œâ”€ Current arc â†’ arc.characters[]
       â”‚
       â””â”€ Deduplicate + rank
           â”‚
           v
    Suggested entities (chips)
           â”‚
     User: attach / dismiss
```

### Post-Accept Extraction â€” Option C Pipeline

```
User accepts AI text
       â”‚
       v
  Async POST /api/intake/extract-entities
       â”‚
       â”œâ”€ Gemini prompt: text + existing Bible names
       â”‚
       â”œâ”€ Parse response â†’ { mentioned[], new[] }
       â”‚
       â””â”€ Store in memory
           â”‚
           v
    Sidebar notification ("3 entities detected")
           â”‚
     User: review â†’ confirm / edit / dismiss
           â”‚
           v
    Confirmed â†’ write to Story Bible repos
```

### Visualization Libraries

| Visualization | Library | Rationale |
|---------------|---------|-----------|
| Relationship Map | `d3-force` + React SVG | Fine-grained control, no heavy deps |
| Timeline | Custom React + CSS | Simple enough, avoids timeline lib overhead |
| Pacing Charts | `recharts` | Already in project or lightweight React charts |

---

## Dependencies

- M4 (Writing UX) complete â€” base writing features stable
- D3 or equivalent for force-directed graph
- Recharts or equivalent for charts
- Gemini 3.0 Pro API â€” for entity extraction

## Risks

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Visualization performance with large cast (50+ characters) | Medium | Medium | Lazy render, cluster nodes, limit visible by arc |
| FTS5 index size with long chapters | Low | Low | FTS5 is designed for this; compress content field if needed |
| Post-accept extraction latency annoying | Medium | Low | Fully async, non-blocking; user writes while extraction runs |
| Scope creep from visualization polish | Medium | High | P0 = functional; visual polish is Phase 6, trimmable |
| Heuristic setup assist accuracy too low | Medium | Medium | Supplement with "Add more" escape hatch; iterate on regex |

---

## Notes

- è¿™æ˜¯ä¸€ä¸ª **writing intelligence** milestone â€” è®©å†™ä½œä½“éªŒä»"å·¥å…·"å‡çº§åˆ°"ä¼™ä¼´"
- Visualization ä¸è¦æ‹–å»¶ï¼ˆç”¨æˆ·æ˜ç¡®è¦æ±‚ï¼‰â€” åŠŸèƒ½æ€§ä¼˜å…ˆï¼Œè§†è§‰ç¾åŒ–åœ¨ Phase 6
- Post-accept extraction æ˜¯ Smart Intake (M6) çš„æœ€å°å‰ç½®éªŒè¯ â€” å¦‚æœ extraction pipeline åœ¨è¿™é‡Œè·‘é€šï¼ŒM6 çš„ decomposition pipeline ä¼šæ›´é¡ºåˆ©
- Product pivot: å†™ä½œä»é›¶å¼€å§‹æ˜¯æ ¸å¿ƒåœºæ™¯ã€‚Chapter Setup Assist å’Œ extraction éƒ½å‡è®¾ç”¨æˆ·åœ¨é€ç« åˆ›ä½œï¼Œä¸æ˜¯åœ¨å¯¼å…¥å·²æœ‰ä½œå“
- æœç´¢åªåš FTS5ï¼Œsemantic search ç•™ç»™ M7 â€” å…ˆè®©æœç´¢æœ‰ç”¨ï¼Œå†è®©æœç´¢èªæ˜
- Relationship map æ˜¯ç”¨æˆ·æœ€ç›´è§‚æ„ŸçŸ¥"è¿™ä¸ªå·¥å…·æ‡‚æˆ‘çš„æ•…äº‹"çš„ feature â€” ä¼˜å…ˆçº§ä¸èƒ½é™
