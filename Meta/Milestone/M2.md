# Milestone 2: Story Bible Core

- **Status**: Complete ✅
- **Completion Date**: 2026-02-07
- **Target Date**: 2026-03-21 (completed 6 weeks early)
- **Owner**: Wayne
- **Duration**: 3 weeks (actual: 2 days)
- **Dependencies**: M1 (Foundation)

## Goal

Implement the **Story Bible** core functionality - the persistent knowledge base that AI references throughout creation. This includes Character management, World building, and Relationship tracking.

## Success Criteria

After M2, users should be able to:

```
✓ Create and manage characters with structured profiles
✓ Define world rules and power systems
✓ Track character relationships
✓ View Story Bible content in Web UI
✓ Access Story Bible via CLI: inxtone bible list/show
```

## Scope

### In Scope

1. **Character System (P0)**
   - Character CRUD operations (create, read, update, delete)
   - Structured profiles: name, appearance, personality, motivation layers
   - Voice samples storage
   - Arc tracking (positive/negative/flat)

2. **World System (P0)**
   - World rules definition
   - Power system configuration
   - Basic location registry
   - Faction builder (basic)

3. **Relationship System (P0)**
   - Relationship CRUD
   - Wayne Principles support (join_reason, independent_goal, etc.)
   - Basic relationship types

4. **UI Implementation**
   - Web: Character list/detail views
   - Web: World settings page
   - Web: Relationship view (list, not graph)
   - CLI: `inxtone bible` commands

### Out of Scope

- Visual relationship graph (M3)
- Foreshadowing tracker (M3)
- AI-powered suggestions (M3)
- Consistency checking (M4)

## Deliverables

| # | Deliverable | Acceptance Criteria |
|---|-------------|---------------------|
| 1 | **StoryBibleService Implementation** | All interface methods implemented with SQLite |
| 2 | **Character UI** | Create/edit/delete characters in web UI |
| 3 | **World UI** | Configure world rules in web UI |
| 4 | **Relationship UI** | Manage relationships in web UI |
| 5 | **CLI Commands** | `inxtone bible list/show/search` working |
| 6 | **API Endpoints** | REST API for all Story Bible operations |

---

## Tasks

### Phase 1: Repository Layer (Day 1-4)

- [ ] Implement `CharacterRepository` with SQLite
  - [ ] CRUD operations
  - [ ] Search by name/role
  - [ ] FTS integration
- [ ] Implement `WorldRepository`
  - [ ] World settings storage
  - [ ] Location CRUD
  - [ ] Faction CRUD
- [ ] Implement `RelationshipRepository`
  - [ ] Relationship CRUD
  - [ ] Get relationships for character
- [ ] Write repository unit tests

### Phase 2: Service Layer (Day 5-8)

- [ ] Implement `StoryBibleService`
  - [ ] Character operations with validation
  - [ ] World operations
  - [ ] Relationship operations with bidirectional handling
  - [ ] Timeline event management
  - [ ] Arc management
- [ ] Integrate with EventBus
  - [ ] Emit CharacterCreated/Updated/Deleted events
  - [ ] Emit WorldUpdated events
- [ ] Write service integration tests

### Phase 3: API Layer (Day 9-11)

- [ ] Create `/api/characters` endpoints
  - [ ] GET /api/characters - list all
  - [ ] GET /api/characters/:id - get by ID
  - [ ] POST /api/characters - create
  - [ ] PUT /api/characters/:id - update
  - [ ] DELETE /api/characters/:id - delete
  - [ ] GET /api/characters/search?q= - search
- [ ] Create `/api/world` endpoints
  - [ ] GET/PUT /api/world - world settings
  - [ ] CRUD /api/world/locations
  - [ ] CRUD /api/world/factions
- [ ] Create `/api/relationships` endpoints
- [ ] Add request validation middleware
- [ ] Write API tests

### Phase 4: Web UI (Day 12-17)

- [ ] **Character Pages**
  - [ ] CharacterList component (grid/list view)
  - [ ] CharacterCard component
  - [ ] CharacterForm component (create/edit)
  - [ ] CharacterDetail page
- [ ] **World Pages**
  - [ ] WorldSettings page
  - [ ] PowerSystem editor
  - [ ] LocationList component
  - [ ] FactionList component
- [ ] **Relationship Pages**
  - [ ] RelationshipList component
  - [ ] RelationshipForm component
- [ ] **State Management**
  - [ ] Zustand stores for characters, world, relationships
  - [ ] React Query for data fetching
- [ ] **Shared Components**
  - [ ] Form inputs (text, select, textarea)
  - [ ] Modal component
  - [ ] Confirmation dialog

### Phase 5: CLI Commands (Day 18-19)

- [ ] Implement `inxtone bible list [type]`
  - [ ] List characters
  - [ ] List locations
  - [ ] List factions
- [ ] Implement `inxtone bible show <type> <id>`
- [ ] Implement `inxtone bible search <query>`
- [ ] Add TUI mode for Story Bible browsing

### Phase 6: Testing & Polish (Day 20-21)

- [x] End-to-end tests
  - [x] API integration tests (76 tests cover create → DB → verify flows)
  - [x] CLI bible command tests (17 tests for list/show/search)
  - [ ] Browser UI E2E tests (deferred to post-M2, requires Playwright setup)
- [x] Performance testing
  - [x] Test with 120 characters (performance seed script)
  - [x] Verify search performance (12 performance tests, all < 50ms)
  - [x] FTS5 index verification (130 entries, 0.37MB database)
- [x] Bug fixes and polish (all code review issues from Phase 4 resolved)

---

## Test Plan

### Unit Tests
- [x] CharacterRepository CRUD tests (18 tests)
- [x] WorldRepository CRUD tests (8 tests)
- [x] RelationshipRepository tests (17 tests)
- [x] StoryBibleService validation tests (61 tests)
- [x] All 9 repository tests (341 total tests)

### Integration Tests
- [x] Service + Repository integration (61 StoryBibleService tests)
- [x] API + Service integration (76 API route tests)
- [x] EventBus event emission (37 EventBus tests)

### E2E Tests
- [x] API integration tests cover create → DB → verify flows
- [x] CLI `bible list/show/search` tests (17 tests)
- [ ] Browser UI E2E tests (deferred, requires Playwright)

### Performance Tests
- [x] Load 120 characters in < 100ms
- [x] FTS5 search in < 50ms
- [x] Batch operations (create/update/delete)
- [x] Concurrent queries
- [x] Database size verification (0.37MB for 120 chars)

---

## Technical Notes

### Data Flow

```
Web UI → React Query → API → StoryBibleService → Repository → SQLite
                                    ↓
                               EventBus → (future listeners)
```

### State Management

```typescript
// Zustand store structure
interface StoryBibleStore {
  characters: Character[];
  world: World | null;
  relationships: Relationship[];
  // Actions
  fetchCharacters(): Promise<void>;
  createCharacter(input: CreateCharacterInput): Promise<Character>;
  // ...
}
```

### API Response Format

```typescript
// Success
{ "data": Character, "meta": { "timestamp": "..." } }

// Error
{ "error": { "code": "NOT_FOUND", "message": "..." } }

// List
{ "data": Character[], "meta": { "total": 42, "page": 1 } }
```

---

## Dependencies

- M1 must be complete (interfaces, database schema, basic UI shell)
- No external dependencies

## Risks

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Complex relationship logic | Medium | Medium | Start with simple bidirectional, enhance later |
| UI complexity | Medium | Medium | Use component library patterns |
| Performance with large datasets | Low | Medium | Add pagination, lazy loading |

---

## Notes

- **核心价值**: Story Bible 是 Inxtone 的核心差异化功能
- Character voice samples 和 arc tracking 可以在 M2 简化实现，M3 完善
- Relationship visual graph 推迟到 M3，M2 只做列表视图
- 确保所有 API 遵循 `packages/core/src/types/api.ts` 定义的格式
