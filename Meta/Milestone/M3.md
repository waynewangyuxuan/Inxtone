# Milestone 3: Writing Workspace

- **Status**: Draft
- **Target Date**: 2026-04-11
- **Owner**: Wayne
- **Duration**: 3 weeks
- **Dependencies**: M2 (Story Bible Core)

## Goal

Implement the **Writing Workspace** - the core writing experience with AI collaboration. Users can write chapters with AI assistance while the system maintains context from the Story Bible.

## Success Criteria

After M3, users should be able to:

```
✓ Create and edit chapters in a distraction-free editor
✓ Use AI (Gemini) to continue writing or generate dialogue
✓ See relevant Story Bible context while writing
✓ Track version history and rollback changes
✓ View writing statistics and progress
```

## Scope

### In Scope

1. **Chapter Editor (P0)**
   - Markdown editor with live preview
   - Auto-save functionality
   - Chapter navigation (prev/next)
   - Word count display

2. **AI Integration (P0)**
   - Gemini API integration
   - Context injection from Story Bible
   - Continuation prompt ("Continue from here")
   - Dialogue generation
   - Streaming responses

3. **Writing Service Implementation**
   - Chapter CRUD
   - Version history
   - Writing sessions tracking
   - Goals management

4. **Plot System (P0)**
   - Arc outliner (hierarchical view)
   - Foreshadowing ledger (basic)
   - Hook tracker

5. **UI Components**
   - Chapter editor page
   - AI sidebar panel
   - Story Bible quick-access panel
   - Writing stats dashboard

### Out of Scope

- Consistency checking (M4)
- Advanced pacing visualizer (future)
- Multi-model support (Claude, GPT - future)
- Embeddings-based context (M4)

## Deliverables

| # | Deliverable | Acceptance Criteria |
|---|-------------|---------------------|
| 1 | **WritingService Implementation** | All interface methods implemented |
| 2 | **AIService Implementation** | Gemini integration working |
| 3 | **Chapter Editor** | Full markdown editing experience |
| 4 | **AI Collaboration Panel** | Working AI sidebar with streaming |
| 5 | **Plot Outliner** | Arc → Chapter hierarchy view |
| 6 | **Version History** | View and rollback to previous versions |

---

## Tasks

### Phase 1: Writing Service (Day 1-5)

- [ ] Implement `WritingRepository`
  - [ ] Chapter CRUD
  - [ ] Volume management
  - [ ] Version storage
  - [ ] Writing session tracking
- [ ] Implement `WritingService`
  - [ ] Chapter operations
  - [ ] Auto-versioning on save
  - [ ] Version comparison (diff)
  - [ ] Rollback functionality
  - [ ] Writing goals (daily/chapter)
  - [ ] Writing sessions
- [ ] Integrate with EventBus
  - [ ] ChapterSaved, ChapterCreated events
  - [ ] ChapterVersionCreated events
- [ ] Write unit tests

### Phase 2: AI Service (Day 6-10)

- [ ] Implement `AIService`
  - [ ] Gemini API client
  - [ ] Rate limiting
  - [ ] Error handling
  - [ ] Response streaming
- [ ] Context Builder
  - [ ] Build context from current chapter
  - [ ] Include selected characters
  - [ ] Include relevant world rules
  - [ ] Token counting and truncation
- [ ] Prompt Templates
  - [ ] Continuation prompt
  - [ ] Dialogue generation prompt
  - [ ] Scene expansion prompt
  - [ ] Character voice prompt
- [ ] Create `/api/ai` endpoints
  - [ ] POST /api/ai/generate - single response
  - [ ] POST /api/ai/stream - streaming response (SSE)
  - [ ] POST /api/ai/build-context - preview context

### Phase 3: Plot System (Day 11-13)

- [ ] Implement Arc management
  - [ ] Arc CRUD
  - [ ] Arc → Chapter association
  - [ ] Arc status tracking
- [ ] Implement Foreshadowing
  - [ ] Create foreshadowing entry
  - [ ] Add hints
  - [ ] Mark as resolved/abandoned
  - [ ] List active foreshadowing
- [ ] Implement Hooks
  - [ ] Hook CRUD
  - [ ] Hook types (opening, cliffhanger, ongoing)
- [ ] API endpoints for plot system

### Phase 4: Chapter Editor UI (Day 14-17)

- [ ] **Editor Component**
  - [ ] Markdown editor (CodeMirror or Monaco)
  - [ ] Live preview toggle
  - [ ] Syntax highlighting
  - [ ] Auto-save indicator
  - [ ] Word count display
- [ ] **Chapter Navigation**
  - [ ] Chapter list sidebar
  - [ ] Prev/Next navigation
  - [ ] Jump to chapter
- [ ] **AI Sidebar**
  - [ ] Prompt input
  - [ ] Response display (streaming)
  - [ ] Quick action buttons
  - [ ] Context preview
- [ ] **Story Bible Panel**
  - [ ] Character quick view
  - [ ] World rules reference
  - [ ] Add to context toggle

### Phase 5: Plot & Stats UI (Day 18-19)

- [ ] **Arc Outliner**
  - [ ] Tree view of Arcs → Chapters
  - [ ] Drag-drop reordering
  - [ ] Status indicators
- [ ] **Foreshadowing View**
  - [ ] Active foreshadowing list
  - [ ] Add hint from chapter
  - [ ] Resolve/abandon actions
- [ ] **Writing Stats**
  - [ ] Daily word count chart
  - [ ] Writing streak
  - [ ] Session history
  - [ ] Goal progress

### Phase 6: Testing & Polish (Day 20-21)

- [ ] End-to-end tests
  - [ ] Write chapter → AI continue → save → verify
  - [ ] Create version → rollback → verify
- [ ] AI integration tests
  - [ ] Mock Gemini responses
  - [ ] Test streaming
  - [ ] Test error handling
- [ ] Performance testing
  - [ ] Editor performance with large chapters
  - [ ] Context building speed
- [ ] Bug fixes

---

## Test Plan

### Unit Tests
- [ ] WritingService version management
- [ ] AIService context building
- [ ] Prompt template rendering

### Integration Tests
- [ ] WritingService + Repository
- [ ] AIService + Gemini API (mocked)
- [ ] Context injection accuracy

### E2E Tests
- [ ] Full writing flow: create chapter → edit → AI assist → save
- [ ] Version history: save → modify → rollback → verify
- [ ] Plot management: create arc → add chapters → reorder

---

## Technical Notes

### AI Context Structure

```typescript
interface AIContext {
  // Current writing context
  currentChapter: {
    title: string;
    content: string;      // Last N paragraphs
    outline?: string;
  };

  // Story Bible context
  characters: Array<{
    name: string;
    appearance: string;
    voiceSamples?: string[];
  }>;

  worldRules?: string[];

  // User instruction
  instruction: string;
}
```

### Streaming Response

```typescript
// Server-Sent Events for AI streaming
// POST /api/ai/stream

// Client receives:
event: chunk
data: {"text": "The door creaked open..."}

event: chunk
data: {"text": " revealing a figure in shadow."}

event: complete
data: {"totalTokens": 150, "finishReason": "stop"}
```

### Editor State

```typescript
interface EditorState {
  chapterId: ChapterId;
  content: string;
  isDirty: boolean;
  lastSaved: Date | null;
  wordCount: number;
  // AI
  aiPanelOpen: boolean;
  aiLoading: boolean;
  aiResponse: string;
}
```

---

## Dependencies

- M2 must be complete (Story Bible for context)
- Gemini API key required

## Risks

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Gemini API rate limits | Medium | Medium | Implement rate limiting, caching |
| Editor performance | Medium | High | Use virtual scrolling, debounce |
| Context too large | High | Medium | Smart truncation, token counting |
| Streaming complexity | Medium | Medium | Robust error handling |

---

## Notes

- **核心价值**: AI 协作写作是 Inxtone 的核心体验
- Context injection 是关键 - 确保相关的 Story Bible 内容被正确注入
- 编辑器选择: CodeMirror 6 (推荐) 或 Monaco
- 初期只支持 Gemini，M4+ 再加其他模型
- Foreshadowing 的 UI 可以简化，核心是 tracking 功能
