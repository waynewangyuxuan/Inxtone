# Milestone 3: Writing Workspace

- **Status**: Draft
- **Target Date**: 2026-04-11
- **Owner**: Wayne
- **Duration**: 3 weeks
- **Dependencies**: M2 (Story Bible Core)

## Goal

Implement the **Writing Workspace** - the core writing experience with AI collaboration. Users can write chapters with AI assistance while the system maintains context from the Story Bible. The core showcase is **AI that knows your story** — not just text generation, but structure-aware, plot-aware content creation.

## Success Criteria

After M3, users should be able to:

```
✓ Create and edit chapters in a distraction-free editor
✓ Use AI (Gemini 2.5 Pro) to continue writing or generate dialogue
✓ See relevant Story Bible context while writing (auto-assembled)
✓ Track version history and rollback changes
✓ Manage plot structure via Arc Outliner and Foreshadowing Tracker
```

## Scope

### In Scope

1. **Chapter Editor (P0)**
   - Markdown editor (`@uiw/react-md-editor`, lightweight ~4.6kB)
   - Auto-save with 2-second debounce
   - Chapter navigation (prev/next)
   - Word count display

2. **AI Integration (P0)**
   - Gemini 2.5 Pro via `@google/genai` SDK
   - **Context Builder**: deterministic FK-based context assembly (see Technical Notes)
   - Continuation, dialogue generation, scene description
   - SSE streaming responses
   - **Sidebar Preview + Accept** interaction model

3. **Writing Service Implementation**
   - Chapter CRUD + Volume CRUD
   - Version history (auto-version on AI generation, manual version)
   - Rollback functionality

4. **Plot System (P0)**
   - Arc outliner (hierarchical view, core value differentiator)
   - Foreshadowing ledger (plant → hint → resolve lifecycle)
   - Hook tracker

5. **UI Components**
   - Three-panel layout: Navigation + Editor + AI Sidebar
   - Chapter editor page with auto-save indicator
   - AI sidebar: context preview, quick actions, streaming response display
   - Story Bible quick-access panel (left panel)
   - Plot Outliner page (Arc → Chapter tree)
   - Foreshadowing Tracker view

### Out of Scope

- Writing Goals / Writing Sessions / Streak tracking (deferred)
- Writing Stats Dashboard (deferred)
- Consistency checking (M4)
- Advanced pacing visualizer (future)
- Multi-model support (Claude, GPT - future)
- Embeddings-based semantic search context (M4)
- Version comparison diff viewer (M4+)
- CLI `inxtone bible` commands (M4+)

## Deliverables

| # | Deliverable | Acceptance Criteria |
|---|-------------|---------------------|
| 1 | **WritingService Implementation** | Chapter/Volume CRUD, saveContent with auto-version, rollback |
| 2 | **AIService Implementation** | Gemini 2.5 Pro streaming, ContextBuilder, prompt templates |
| 3 | **Chapter Editor** | `@uiw/react-md-editor` with auto-save, word count |
| 4 | **AI Collaboration Panel** | Sidebar with context preview, streaming response, accept/reject |
| 5 | **Plot Outliner** | Arc → Chapter hierarchy view + Foreshadowing tracker |
| 6 | **Version History** | Auto-version before AI generation, manual version, rollback |

---

## Tasks

### Phase 1: Writing Service (Day 1-5)

- [ ] Implement `WritingRepository`
  - [ ] Chapter CRUD
  - [ ] Volume management
  - [ ] Version storage (create, list, get, rollback)
- [ ] Implement `WritingService`
  - [ ] Chapter operations (CRUD, reorder, filter by status/volume/arc)
  - [ ] `saveContent()` with auto-save support
  - [ ] Auto-versioning (before AI generation, every 500 words, every 30 min)
  - [ ] Manual version creation
  - [ ] Rollback functionality (backup current → restore target)
  - [ ] `getWordCount()`, `getTotalWordCount()`
- [ ] Integrate with EventBus
  - [ ] CHAPTER_SAVED, CHAPTER_CREATED, CHAPTER_DELETED events
  - [ ] VERSION_CREATED events (with source: auto/manual/ai_backup/rollback_backup)
  - [ ] CHAPTER_STATUS_CHANGED events
- [ ] Write unit tests

### Phase 2: AI Service (Day 6-10)

- [ ] Implement `GeminiProvider`
  - [ ] `@google/genai` SDK integration (model: `gemini-2.5-pro`)
  - [ ] Streaming response via `generateContentStream()`
  - [ ] Rate limiting (respect API quotas)
  - [ ] Error handling (auth, rate limit, content filter, network)
- [ ] Implement `ContextBuilder` (核心大脑)
  - [ ] Layer 1 — Required: current chapter content + outline + prev chapter tail
  - [ ] Layer 2 — FK expansion: chapter.characters[] → full profiles (motivation, facets, voiceSamples)
  - [ ] Layer 2 — FK expansion: chapter.locations[] → descriptions
  - [ ] Layer 2 — FK expansion: chapter.arcId → Arc structure + progress
  - [ ] Layer 2 — FK expansion: character relationships (including Wayne Principles fields)
  - [ ] Layer 3 — Plot awareness: chapter.foreshadowingHinted[] → foreshadowing content
  - [ ] Layer 3 — Plot awareness: active foreshadowing in current Arc
  - [ ] Layer 3 — Plot awareness: prev chapter hook → continuity
  - [ ] Layer 4 — World rules: powerSystem.coreRules, socialRules
  - [ ] Layer 5 — User-selected additional context
  - [ ] Token budget management (estimate → fill by priority → truncate)
- [ ] Implement `PromptAssembler`
  - [ ] Continuation prompt template
  - [ ] Dialogue generation prompt template
  - [ ] Scene description prompt template
  - [ ] Brainstorm prompt template
  - [ ] Template variable injection (context + instruction → final prompt)
- [ ] Create `/api/ai` endpoints
  - [ ] POST /api/ai/stream - streaming response (SSE)
  - [ ] POST /api/ai/build-context - preview assembled context
  - [ ] GET /api/ai/providers - available provider info

### Phase 3: Plot System API (Day 11-13)

> Note: Arc, Foreshadowing, Hook repositories and service methods already exist in M2's StoryBibleService.
> This phase focuses on exposing them via API endpoints and connecting to the writing workflow.

- [ ] Create `/api/arcs` endpoints (CRUD + progress)
- [ ] Create `/api/foreshadowing` endpoints (CRUD + addHint + resolve + abandon)
- [ ] Create `/api/hooks` endpoints (CRUD + strength tracking)
- [ ] Wire plot data into ContextBuilder
  - [ ] Auto-include foreshadowing hints for current chapter
  - [ ] Include arc progress in context
- [ ] Write API tests

### Phase 4: Chapter Editor UI (Day 14-17)

- [ ] **Editor Component**
  - [ ] `@uiw/react-md-editor` integration
  - [ ] Auto-save with debounce (2s idle → save, 5min max → force save)
  - [ ] Auto-save indicator ("已自动保存" / "未保存")
  - [ ] Word count display
- [ ] **Three-Panel Layout**
  - [ ] Left panel: Chapter list (filterable by Arc) + Story Bible quick-ref
  - [ ] Center: Editor
  - [ ] Right panel: AI Sidebar (collapsible)
- [ ] **AI Sidebar**
  - [ ] Context preview: show assembled context items (characters, locations, foreshadowing)
  - [ ] Context editing: toggle items on/off
  - [ ] Prompt input field
  - [ ] Quick action buttons (Continue, Dialogue, Describe, Brainstorm)
  - [ ] Streaming response display area
  - [ ] Accept / Reject / Regenerate buttons
  - [ ] Insert accepted content at cursor position
- [ ] **Story Bible Panel (Left)**
  - [ ] Current chapter's characters (quick view)
  - [ ] Current chapter's locations
  - [ ] Active foreshadowing for this chapter
  - [ ] "Add to AI context" toggle per item

### Phase 5: Plot UI (Day 18-19)

- [ ] **Arc Outliner**
  - [ ] Tree view: Arc → Sections → Chapters
  - [ ] Progress indicators (%, status badges)
  - [ ] Click to navigate to chapter
  - [ ] Status indicators (planned/in_progress/complete)
- [ ] **Foreshadowing Tracker**
  - [ ] Active foreshadowing list with status
  - [ ] Plant → Hint → Resolve lifecycle visualization
  - [ ] Add hint from current chapter action
  - [ ] Resolve/abandon actions
  - [ ] Overdue foreshadowing warnings
- [ ] **Hook Tracker**
  - [ ] Hooks by chapter
  - [ ] Strength indicator

### Phase 6: Testing & Polish (Day 20-21)

- [ ] End-to-end tests
  - [ ] Write chapter → AI continue → accept → save → verify content
  - [ ] Create version → modify → rollback → verify
  - [ ] Plot flow: create arc → assign chapters → track progress
- [ ] AI integration tests
  - [ ] Mock Gemini responses for deterministic testing
  - [ ] Test streaming (chunk-by-chunk delivery)
  - [ ] Test error handling (rate limit, auth, network)
  - [ ] Test ContextBuilder assembly accuracy
- [ ] Performance testing
  - [ ] Editor performance with large chapters (10K+ words)
  - [ ] Context building speed (target: <500ms)
- [ ] Bug fixes

---

## Test Plan

### Unit Tests
- [ ] WritingService: saveContent, auto-version triggers, rollback
- [ ] ContextBuilder: layer assembly, priority ordering, token budgeting
- [ ] PromptAssembler: template rendering with variables
- [ ] GeminiProvider: stream parsing, error handling

### Integration Tests
- [ ] WritingService + Repository (SQLite)
- [ ] ContextBuilder + StoryBibleService (FK expansion accuracy)
- [ ] AIService + Gemini API (mocked)
- [ ] API endpoints + Service layer

### E2E Tests
- [ ] Full writing flow: create chapter → edit → AI assist → accept → save
- [ ] Version history: save → AI generate (auto-backup) → rollback → verify
- [ ] Plot management: create arc → add chapters → track foreshadowing → resolve

---

## Technical Notes

### ContextBuilder Architecture (核心大脑)

```
输入: chapterId + userInstruction
  │
  ▼
Layer 1 — Required (always included):
  ├─ chapter.content (last N paragraphs if too long)
  ├─ chapter.outline (goal, scenes, hookEnding)
  └─ prevChapter tail (last 500 chars)
  │
  ▼
Layer 2 — FK Expansion (auto-detected from chapter metadata):
  ├─ chapter.characters[] → CharacterRepo.findById() each
  │   → name, appearance, motivation, facets, voiceSamples
  ├─ chapter.locations[] → LocationRepo.findById() each
  │   → name, type, significance, atmosphere
  ├─ chapter.arcId → ArcRepo.findById()
  │   → name, type, progress, sections, status
  └─ characters间的 Relationships → RelationshipRepo.findByCharacter()
      → type, evolution, Wayne Principles (joinReason, independentGoal...)
  │
  ▼
Layer 3 — Plot Awareness:
  ├─ chapter.foreshadowingHinted[] → ForeshadowingRepo.findById() each
  │   → content, plantedText, hints so far
  ├─ Active foreshadowing in current Arc (planted but unresolved)
  └─ prevChapter hooks → HookRepo.findByChapter(prevChapterId)
  │
  ▼
Layer 4 — World Rules:
  ├─ WorldRepo.get() → powerSystem.coreRules (always included)
  └─ socialRules (if relevant characters/factions involved)
  │
  ▼
Layer 5 — User-Selected:
  └─ Additional items user explicitly toggled in UI
  │
  ▼
Token Budget Management:
  budget = model.maxInputTokens - reserveForOutput(4000) - reserveForPrompt(2000)
  Fill layers 1-5 by priority, truncate from lowest priority if over budget
  │
  ▼
Output: Formatted context string + token stats + truncation report
```

**Key insight**: No semantic search needed for MVP. Chapter.characters[], Chapter.locations[],
Chapter.foreshadowingHinted[] etc. provide deterministic, author-intent-driven context assembly.
Semantic search (M4) will enhance this, not replace it.

### AI Interaction Model: Sidebar Preview + Accept

```
User clicks "Continue Scene" in AI sidebar
  │
  ▼
ContextBuilder assembles context from chapter FK metadata
  │
  ▼
PromptAssembler injects context + user instruction into template
  │
  ▼
GeminiProvider streams response via SSE
  │
  ▼
AI Sidebar shows streaming text in preview area
  │
  ▼
User reviews and chooses:
  ├─ [Accept] → content inserted at editor cursor position
  ├─ [Reject] → content discarded
  └─ [Regenerate] → re-run with same context
```

### AI Provider Configuration

```typescript
// MVP: Gemini 2.5 Pro only, no fallback chain
const AI_CONFIG = {
  provider: 'gemini',
  model: 'gemini-2.5-pro',
  sdk: '@google/genai',      // New official SDK (replaces @google/generative-ai)
  maxInputTokens: 1_000_000, // 1M context window
  defaultTemperature: 0.7,
  maxOutputTokens: 4000,
};
```

### Streaming Response

```typescript
// Server-Sent Events for AI streaming
// POST /api/ai/stream

// Client receives:
event: chunk
data: {"text": "The door creaked open..."}

event: chunk
data: {"text": " revealing a figure in shadow."}

event: complete
data: {"totalTokens": 150, "finishReason": "stop"}

event: error
data: {"error": "Rate limit exceeded", "retriable": true}
```

### Editor State

```typescript
interface EditorState {
  chapterId: ChapterId;
  content: string;
  isDirty: boolean;
  lastSaved: Date | null;
  wordCount: number;
  // AI
  aiPanelOpen: boolean;
  aiLoading: boolean;
  aiResponses: AIResponseOption[];  // Multiple options possible
  contextPreview: ContextItem[];    // What AI "knows" for this chapter
}

interface AIResponseOption {
  id: string;
  content: string;
  label?: string;   // "Option A", "Option B"
}
```

### Editor Component

```typescript
// @uiw/react-md-editor — lightweight (~4.6kB gzip)
// Built-in: Markdown syntax highlighting, live preview, auto-indent
// onChange returns string directly — perfect for auto-save debounce

import MDEditor from '@uiw/react-md-editor';

<MDEditor
  value={content}
  onChange={handleChange}  // string → debounce → saveContent()
  height={600}
/>
```

---

## Dependencies

- M2 must be complete (Story Bible service + repositories for context)
- Gemini API key required (BYOK)
- `@google/genai` npm package
- `@uiw/react-md-editor` npm package

## Risks

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Gemini API rate limits | Medium | Medium | Rate limiting in GeminiProvider, user feedback |
| Editor performance with large chapters | Medium | High | Debounce saves, lazy rendering |
| Context too large for token budget | High | Medium | Priority-based truncation, token counting |
| Streaming SSE complexity | Medium | Medium | Robust error handling, reconnect logic |
| ContextBuilder latency (many FK lookups) | Low | Medium | Batch queries, cache hot data |

---

## Notes

- **核心价值**: AI 协作写作是 Inxtone 的核心体验，但真正的差异化在于 Context Builder —— AI 知道你的故事结构
- **ContextBuilder 是引擎的大脑**: 基于 Chapter 实体的外键做确定性 context 组装，不依赖 semantic search
- **Plot UI 是核心价值感体现**: Arc Outliner + Foreshadowing Tracker 给作者"系统帮我记着"的安全感
- **编辑器选择**: `@uiw/react-md-editor` (最轻量，5分钟集成，后期可换 CodeMirror 6)
- **AI 交互模式**: Sidebar Preview + Accept (用户掌控感 > 行内流式)
- **MVP 只支持 Gemini 2.5 Pro**: 单 provider，无 fallback，M4+ 再加其他模型
- **Writing Goals / Stats 已推迟**: 非核心展示功能，不在 M3 范围内
