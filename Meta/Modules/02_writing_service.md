# WritingService 模块设计

> 管理写作流程：章节编辑、版本控制

---

## 一、模块职责

| 子功能 | 说明 |
|--------|------|
| **Volume/Chapter CRUD** | 卷、章节的增删改查 |
| **Content Editing** | 内容保存 (手动 Ctrl+S / Save 按钮) |
| **Version Control** | 版本历史、回滚 |

> **注意**: Writing Goals（每日目标、连续天数）和 Writing Sessions（写作时长追踪）已从 M3 范围推迟，后续 milestone 再实现。

---

## 二、核心工作流

### 2.1 章节编辑与手动保存

```
用户操作: 打开章节编辑器
    │
    ▼
┌─────────────────────────────────────────┐
│ 1. 加载章节内容                          │
│    WritingService.getChapter(id)        │
│    - content: 正文内容                   │
│    - outline: 本章大纲                   │
│    - word_count: 当前字数                │
└─────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────┐
│ 2. 用户编辑                              │
│    │                                     │
│    │  每次按键 ───→ 更新本地状态         │
│    │              标记 isDirty = true    │
│    │                                     │
│    │  Ctrl+S / Save 按钮                │
│    │      ───→ 触发手动保存              │
│    │                                     │
└─────────────────────────────────────────┘
    │
    ▼ (手动保存触发)
┌─────────────────────────────────────────┐
│ 3. WritingService.saveContent           │
│    │                                     │
│    ├─→ 计算字数差异 (delta)              │
│    │                                     │
│    ├─→ 更新 chapters 表                  │
│    │   - content, word_count, updated_at │
│    │                                     │
│    └─→ 发送事件 CHAPTER_SAVED           │
└─────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────┐
│ 4. UI 反馈                               │
│    - isDirty = false                    │
│    - 显示 "已保存 ✓"                    │
│    - 更新字数统计                        │
└─────────────────────────────────────────┘

注意:
- 切换章节/关闭页面时，如果 isDirty = true → 弹出确认框
- 版本创建独立于保存 (用户手动创建 或 AI 生成前自动创建)
```

### 2.2 版本控制

```
┌─────────────────────────────────────────────────────────┐
│                    版本创建时机                          │
├─────────────────────────────────────────────────────────┤
│ 手动创建:                                               │
│   - 用户点击 "创建版本" 按钮                            │
│                                                         │
│ 自动创建 (仅以下场景):                                  │
│   - AI 生成前自动快照 (source = 'ai_backup')            │
└─────────────────────────────────────────────────────────┘

版本数据结构:
┌─────────────────────────────────────────┐
│ versions 表                              │
│ ─────────────────────────────────────── │
│ id: 自增                                 │
│ chapter_id: 关联章节                     │
│ content: 完整内容快照                    │
│ word_count: 该版本字数                   │
│ created_at: 创建时间                     │
│ source: 'auto' | 'manual' | 'ai_backup' │
│ summary: 可选的版本说明                  │
└─────────────────────────────────────────┘

版本回滚流程:
    │
    ▼
┌─────────────────────────────────────────┐
│ 1. 显示版本历史列表                      │
│    - 时间、字数、来源                    │
│    - 支持版本对比 (DiffViewer)          │
└─────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────┐
│ 2. 用户选择回滚到某版本                  │
│    - 显示确认对话框                      │
│    - 提示: "当前内容将创建新版本保存"    │
└─────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────┐
│ 3. WritingService.rollbackToVersion     │
│    │                                     │
│    ├─→ 创建当前内容的版本 (备份)         │
│    │   source = 'rollback_backup'       │
│    │                                     │
│    ├─→ 用目标版本内容覆盖当前           │
│    │                                     │
│    └─→ 发送事件 CHAPTER_ROLLBACK        │
└─────────────────────────────────────────┘
```

### ~~2.3 写作目标追踪~~ (已推迟)

> Writing Goals 和 Writing Sessions 已从 M3 范围推迟。
> 接口定义保留在 `services.ts` 中，后续 milestone 实现。

---

## 三、数据流向

```
┌──────────────────────────────────────────────────────────┐
│                     编辑器界面                            │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐                   │
│  │内容区域  │  │字数统计 │  │版本历史 │                   │
│  └────┬────┘  └────┬────┘  └────┬────┘                   │
└───────┼────────────┼────────────┼────────────────────────┘
        │            │            │
        └────────────┴────────────┘
                            │
                    ┌───────┴───────┐
                    │   Writing     │
                    │   Service     │
                    └───────┬───────┘
                            │
        ┌───────────────────┼───────────────────┐
        │                   │                   │
        ▼                   ▼                   ▼
┌───────────────┐   ┌───────────────┐
│   chapters    │   │   versions    │
│      表       │   │      表       │
└───────────────┘   └───────────────┘
```

---

## 四、与其他模块的交互

| 交互模块 | 方向 | 场景 |
|----------|------|------|
| **AIService** | → | AI 续写前获取当前内容和上下文 |
| **StoryBibleService** | ← | 获取大纲、伏笔信息显示在侧边栏 |
| **QualityService** | → | 保存后触发一致性检查 |
| **SearchService** | → | 章节内容变化后更新索引 |
| **EventBus** | → | 发送 SAVED/CREATED/DELETED 事件 |
| **FileWatcher** | ↔ | 支持导出 Markdown，监听外部修改 |

---

## 五、关键设计决策

### 5.1 手动保存策略

```
MVP 选择手动保存 (Manual Save):
- Ctrl+S 或 工具栏 Save 按钮
- 简化状态管理，避免 auto-save 带来的复杂边界问题

isDirty 状态管理:
- 编辑内容 → isDirty = true
- 保存成功 → isDirty = false
- isDirty = true 时切换章节/关闭页面 → 弹出确认框:
  "有未保存的更改，是否保存？" [保存] [不保存] [取消]

未来考虑:
- 如果用户反馈需要 auto-save，M4+ 再加入
- 可选: localStorage 临时备份 (防止浏览器崩溃丢失)
```

### 5.2 版本存储策略

```
问题: 版本快照会占用大量空间

解决方案: 分层存储

近期版本 (7天内):
  - 保留所有版本
  - 存储完整内容

历史版本 (7天以上):
  - 每天保留最后一个版本
  - 可选: 压缩存储 (gzip)

手动版本:
  - 永久保留
  - 不受清理策略影响
```

### 5.3 章节状态机

```
         ┌─────────┐
         │ outline │ ←── 新建默认状态（只有大纲）
         └────┬────┘
              │ 开始写作
              ▼
         ┌─────────┐
         │  draft  │ ←── 初稿写作中
         └────┬────┘
              │ 进入修改阶段
              ▼
         ┌─────────┐
         │revision │ ←── 修改润色中
         └────┬────┘
              │ 校对完成
              ▼
         ┌─────────┐
         │  done   │ ←── 终稿完成
         └─────────┘

状态影响:
- outline/draft: 可自由编辑
- revision: 编辑时提示 "已进入修改阶段，确认修改？"
- done: 需要先解锁才能编辑
```

---

## 六、错误处理

| 错误场景 | 处理 |
|----------|------|
| 手动保存失败 | 保持 isDirty = true + 提示用户重试 |
| 版本创建失败 | 不阻断编辑，记录日志，后台重试 |
| 并发编辑冲突 | Last Write Wins + 冲突版本保留 |
| 存储空间不足 | 提示清理旧版本 |

---

*Review 重点: 手动保存 + isDirty 管理、版本分层存储、状态机、FK cleanup*
