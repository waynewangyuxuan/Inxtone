# AIService æ¨¡å—è®¾è®¡

> AI è°ƒç”¨çš„æ ¸å¿ƒæ¨¡å—ï¼šContext æ„å»ºã€Gemini è°ƒç”¨ã€æµå¼è¾“å‡º

---

## ä¸€ã€æ¨¡å—èŒè´£

| å­åŠŸèƒ½ | è¯´æ˜ |
|--------|------|
| **GeminiProvider** | Gemini 2.5 Pro è°ƒç”¨ (`@google/genai` SDK) |
| **ContextBuilder** | åŸºäº Chapter å¤–é”®çš„ç¡®å®šæ€§ context ç»„è£… (æ ¸å¿ƒå¤§è„‘) |
| **PromptAssembler** | æ¨¡æ¿åŒ–çš„æç¤ºè¯ç³»ç»Ÿ |
| **æµå¼è¾“å‡º** | SSE å®æ—¶è¿”å›ç”Ÿæˆå†…å®¹ |
| **é”™è¯¯å¤„ç†** | é‡è¯•ã€Rate Limit å¤„ç† |

> **MVP å†³ç­–**: åªæ”¯æŒ Gemini 2.5 Proï¼Œä¸åš Provider æŠ½è±¡å’Œ fallbackã€‚
> å¤š Provider æ”¯æŒ (Claude, OpenAI) æ¨è¿Ÿåˆ° M4+ã€‚

---

## äºŒã€æ ¸å¿ƒå·¥ä½œæµ

### 2.1 AI ç»­å†™ç« èŠ‚

```
ç”¨æˆ·æ“ä½œ: åœ¨ç¼–è¾‘å™¨ä¸­æŒ‰ Ctrl+Aï¼Œé€‰æ‹© "ç»­å†™"
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. æ”¶é›†ç”¨æˆ·è¾“å…¥                          â”‚
â”‚    - å½“å‰ç« èŠ‚å†…å®¹                        â”‚
â”‚    - ç»­å†™é•¿åº¦åå¥½ (çŸ­/ä¸­/é•¿)             â”‚
â”‚    - é£æ ¼åå¥½ (ç®€æ´/è¯¦ç»†)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. AIService.continueScene(input)       â”‚
â”‚    â”‚                                     â”‚
â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚    â”‚  â”‚ 2.1 æ„å»º Context               â”‚â”‚
â”‚    â”‚  â”‚     ContextBuilder.build()     â”‚â”‚
â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚    â”‚                 â”‚                   â”‚
â”‚    â”‚                 â–¼                   â”‚
â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚    â”‚  â”‚ 2.2 é€‰æ‹© Prompt æ¨¡æ¿           â”‚â”‚
â”‚    â”‚  â”‚     prompts/continue.md        â”‚â”‚
â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚    â”‚                 â”‚                   â”‚
â”‚    â”‚                 â–¼                   â”‚
â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚    â”‚  â”‚ 2.3 ç»„è£…æœ€ç»ˆ Prompt            â”‚â”‚
â”‚    â”‚  â”‚     {context} + {template}     â”‚â”‚
â”‚    â”‚  â”‚     + {current_content}        â”‚â”‚
â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚    â”‚                 â”‚                   â”‚
â”‚    â”‚                 â–¼                   â”‚
â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚    â”‚  â”‚ 2.4 è°ƒç”¨ Provider              â”‚â”‚
â”‚    â”‚  â”‚     provider.stream(prompt)    â”‚â”‚
â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚    â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼ (æµå¼è¿”å›)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. å‰ç«¯é€å­—æ˜¾ç¤º                          â”‚
â”‚    - ç”Ÿæˆä¸­: æ‰€æœ‰ AI æŒ‰é’®ç¦ç”¨           â”‚
â”‚    - é€ chunk è¿½åŠ åˆ°é¢„è§ˆåŒº               â”‚
â”‚    - æµä¸­æ–­ â†’ ä¿ç•™å·²æ”¶åˆ°çš„éƒ¨åˆ†å†…å®¹      â”‚
â”‚    - æ˜¾ç¤º Token ä½¿ç”¨é‡                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼ (ç”Ÿæˆå®Œæˆ æˆ– æµä¸­æ–­)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. ç”¨æˆ·å†³ç­–                              â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚    â”‚  é‡‡çº³   â”‚ â”‚ é‡æ–°ç”Ÿæˆ â”‚ â”‚  æ‹’ç»   â”‚ â”‚
â”‚    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â”‚
â”‚         â”‚           â”‚           â”‚       â”‚
â”‚    æ’å…¥åˆ°å…‰æ ‡  å¤ç”¨context+   å¿…é¡»å¡«å†™   â”‚
â”‚    ä½ç½®       æ³¨å…¥reject     æ‹’ç»ç†ç”±   â”‚
â”‚    (å«åŠæˆª)   reasoné‡æ–°ç”Ÿæˆ            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 ContextBuilder æ„å»ºæµç¨‹ (æ ¸å¿ƒå¤§è„‘)

> **å…³é”®è®¾è®¡å˜æ›´**: MVP ä¸ä½¿ç”¨è¯­ä¹‰æœç´¢ã€‚æ”¹ä¸ºåŸºäº Chapter å®ä½“å¤–é”®çš„**ç¡®å®šæ€§ context ç»„è£…**ã€‚
> Chapter.characters[], Chapter.locations[], Chapter.foreshadowingHinted[] ç­‰å¤–é”®æä¾›
> ç²¾ç¡®çš„ã€ä½œè€…æ„å›¾é©±åŠ¨çš„ contextã€‚è¯­ä¹‰æœç´¢ (M4) å°†ä½œä¸ºå¢å¼ºï¼Œè€Œéæ›¿ä»£ã€‚

```
è¾“å…¥: chapterId + userInstruction
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. è®¡ç®—å¯ç”¨ Token é¢„ç®—                   â”‚
â”‚                                         â”‚
â”‚    æ€»é¢„ç®— = 1,000,000 (Gemini 2.5 Pro) â”‚
â”‚           - reserveForOutput (4000)     â”‚
â”‚           - reserveForPrompt (2000)     â”‚
â”‚                                         â”‚
â”‚    å¯ç”¨: ~994,000 tokens               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. åˆ†å±‚æ”¶é›† (Layer-based Assembly)      â”‚
â”‚                                         â”‚
â”‚ Layer 1 â€” Required (å¿…é¡»):             â”‚
â”‚    a. å½“å‰ç« èŠ‚ content                  â”‚
â”‚    b. å½“å‰ç« èŠ‚ outline (goal, scenes)  â”‚
â”‚    c. å‰ä¸€ç« æœ«å°¾ 500 å­—                 â”‚
â”‚                                         â”‚
â”‚ Layer 2 â€” FK Expansion (æ‰¹é‡æŸ¥è¯¢):     â”‚
â”‚    d. chapter.characters[]              â”‚
â”‚       â†’ CharacterRepo.findByIds([...]) â”‚
â”‚       (name, appearance, motivation,   â”‚
â”‚        facets, voiceSamples)           â”‚
â”‚    e. chapter.locations[]               â”‚
â”‚       â†’ LocationRepo.findByIds([...]) â”‚
â”‚    f. chapter.arcId â†’ Arc ç»“æ„+è¿›åº¦     â”‚
â”‚    g. Scoped Relationships:            â”‚
â”‚       â†’ ä»…æŸ¥æœ¬ç« è§’è‰²é—´çš„ç›´æ¥å…³ç³»        â”‚
â”‚       â†’ Aâ†”B æœ‰ç›´æ¥å…³ç³» â†’ åŒ…å«          â”‚
â”‚       â†’ Aâ†”B æ— ç›´æ¥å…³ç³»ä½† Aâ†’Câ†’B â†’ åŒ…å«  â”‚
â”‚       â†’ ä¸æ‹‰å…¥ç« å¤–è§’è‰² C çš„å®Œæ•´æ¡£æ¡ˆ     â”‚
â”‚                                         â”‚
â”‚ Layer 3 â€” Plot Awareness (æ‰¹é‡æŸ¥è¯¢):   â”‚
â”‚    h. chapter.foreshadowingHinted[]    â”‚
â”‚       â†’ ForeshadowingRepo.findByIds() â”‚
â”‚    i. å½“å‰ Arc çš„ active foreshadowing â”‚
â”‚    j. ä¸Šä¸€ç« çš„ hook â†’ ç¡®ä¿è¿è´¯         â”‚
â”‚                                         â”‚
â”‚ Layer 4 â€” World Rules (ä¸–ç•Œè§„åˆ™):      â”‚
â”‚    k. powerSystem.coreRules (æ€»æ˜¯åŒ…å«) â”‚
â”‚    l. socialRules (å¦‚æœç›¸å…³)           â”‚
â”‚                                         â”‚
â”‚ Layer 5 â€” User-Selected (ç”¨æˆ·é€‰æ‹©):    â”‚
â”‚    m. ç”¨æˆ·åœ¨ UI ä¸­æ‰‹åŠ¨æ·»åŠ çš„å†…å®¹       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. æŒ‰ä¼˜å…ˆçº§å¡«å……ï¼Œç›´åˆ°è¾¾åˆ°é¢„ç®—            â”‚
â”‚                                         â”‚
â”‚    ä¼˜å…ˆçº§: L1 > L2 > L3 > L4 > L5     â”‚
â”‚    è¶…å‡ºé¢„ç®—æ—¶ä»ä½ä¼˜å…ˆçº§å¼€å§‹è£å‰ª         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. æ ¼å¼åŒ–è¾“å‡º                            â”‚
â”‚                                         â”‚
â”‚    <context>                            â”‚
â”‚    ## è§’è‰²æ¡£æ¡ˆ                          â”‚
â”‚    ### æ—é€¸                             â”‚
â”‚    {å®Œæ•´æ¡£æ¡ˆ: å¤–è²Œ/åŠ¨æœº/æ€§æ ¼é¢}         â”‚
â”‚    ### é™ˆæµ©                             â”‚
â”‚    {å®Œæ•´æ¡£æ¡ˆ}                           â”‚
â”‚                                         â”‚
â”‚    ## è§’è‰²å…³ç³» (ä»…æœ¬ç« è§’è‰²é—´)            â”‚
â”‚    æ—é€¸ â†” é™ˆæµ©: å®¿æ•Œ (å§‹äºCh.3çš„ç¾è¾±)   â”‚
â”‚                                         â”‚
â”‚    ## åœºæ™¯åœ°ç‚¹                          â”‚
â”‚    å®—é—¨æ“‚å°: {æè¿°, æ°›å›´}               â”‚
â”‚                                         â”‚
â”‚    ## å‰§æƒ…æé†’                          â”‚
â”‚    âš  æœ¬ç« éœ€æš—ç¤ºä¼ç¬”: è€çˆ·å­çš„çœŸå®èº«ä»½   â”‚
â”‚    ğŸ“Œ å½“å‰ Arc è¿›åº¦: 73% (å¤©æ‰å¯¹å†³)     â”‚
â”‚                                         â”‚
â”‚    ## ä¸–ç•Œè§„åˆ™                          â”‚
â”‚    {åŠ›é‡ä½“ç³»æ ¸å¿ƒè§„åˆ™}                    â”‚
â”‚                                         â”‚
â”‚    ## å‰æ–‡                              â”‚
â”‚    {å‰ä¸€ç« æœ«å°¾}                         â”‚
â”‚                                         â”‚
â”‚    ## æœ¬ç« å¤§çº²                          â”‚
â”‚    {goal, scenes, hookEnding}           â”‚
â”‚    </context>                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 Gemini Provider è°ƒç”¨

> **MVP å†³ç­–**: å• Provider (Gemini 2.5 Pro)ï¼Œä¸åš fallback chainã€‚
> Provider æŠ½è±¡å±‚ä¿ç•™åœ¨æ¥å£å®šä¹‰ä¸­ (services.ts)ï¼Œä½† M3 åªå®ç° GeminiProviderã€‚

```
é…ç½®:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ai_config:                               â”‚
â”‚   provider: gemini                       â”‚
â”‚   model: gemini-2.5-pro                 â”‚
â”‚   sdk: @google/genai                    â”‚
â”‚   temperature: 0.7                      â”‚
â”‚   max_output_tokens: 4000               â”‚
â”‚   max_input_tokens: 1_000_000           â”‚
â”‚   retry_count: 3                        â”‚
â”‚   retry_delay: 1000ms                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è°ƒç”¨æµç¨‹:
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ try:                                    â”‚
â”‚   for attempt in 1..retry_count:       â”‚
â”‚     result = gemini.generateContent-   â”‚
â”‚              Stream(prompt)            â”‚
â”‚     if success: stream result          â”‚
â”‚     if RateLimit: wait retry-after     â”‚
â”‚     if Timeout: retry with backoff     â”‚
â”‚                                         â”‚
â”‚ catch AuthError:                        â”‚
â”‚   â†’ æç¤ºç”¨æˆ·æ£€æŸ¥ API Key              â”‚
â”‚                                         â”‚
â”‚ catch ContentFilter:                    â”‚
â”‚   â†’ æç¤ºå†…å®¹è¢«è¿‡æ»¤ï¼Œå»ºè®®ä¿®æ”¹è¾“å…¥      â”‚
â”‚                                         â”‚
â”‚ catch NetworkError:                     â”‚
â”‚   â†’ é‡è¯•ï¼Œè¶…è¿‡æ¬¡æ•°åæç¤ºç”¨æˆ·          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2.4 å››ç§ç”Ÿæˆæ¨¡å¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Continue    â”‚ ç»­å†™æ¥ä¸‹æ¥çš„å®Œæ•´å†…å®¹ (æ ¸å¿ƒåŠŸèƒ½)           â”‚
â”‚ (ç»­å†™)      â”‚ Accept â†’ æ’å…¥åˆ°ç¼–è¾‘å™¨å…‰æ ‡ä½ç½®            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Dialogue    â”‚ åªç”Ÿæˆä¸€æ®µå¯¹è¯ï¼Œä¸“æ³¨è§’è‰²äº¤äº’              â”‚
â”‚ (å¯¹è¯)      â”‚ Accept â†’ æ’å…¥åˆ°ç¼–è¾‘å™¨å…‰æ ‡ä½ç½®            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Describe    â”‚ åªç”Ÿæˆä¸€æ®µæå†™ (åœºæ™¯/äººç‰©/åŠ¨ä½œ)          â”‚
â”‚ (æå†™)      â”‚ Accept â†’ æ’å…¥åˆ°ç¼–è¾‘å™¨å…‰æ ‡ä½ç½®            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Brainstorm  â”‚ ç»™ç”¨æˆ·ä¸€ä¸ªç»­å†™æ¦‚å¿µ/æ–¹å‘é¢„è§ˆ              â”‚
â”‚ (å¤´è„‘é£æš´)  â”‚ æ»¡æ„ â†’ åŸºäºæ¦‚å¿µæ‰§è¡Œ Continue ç»­å†™        â”‚
â”‚             â”‚ ä¸æ»¡æ„ â†’ Reject + ç†ç”± â†’ Regenerate     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.5 Reject + Regenerate æµç¨‹

```
[Reject] ç‚¹å‡»:
  â”‚
  â–¼
å¼¹å‡º: "ä¸ºä»€ä¹ˆä¸æ»¡æ„ï¼Ÿ" (å¿…å¡«ç†ç”±)
  â”‚
  â–¼
ä¿å­˜ { rejectedContent, rejectReason, generationType }
  â”‚
  â–¼
[Regenerate] ç‚¹å‡»:
  â”‚
  â”œâ”€ é»˜è®¤: å¤ç”¨å½“å‰ context (ä¸é‡æ–° build)
  â”‚
  â”œâ”€ Prompt æ³¨å…¥:
  â”‚   "ä¸Šæ¬¡ç”Ÿæˆè¢«æ‹’ç»ã€‚
  â”‚    åŸå› : {{rejectReason}}
  â”‚    è¢«æ‹’å†…å®¹: {{rejectedContent}}
  â”‚    è¯·é¿å…ç›¸åŒé—®é¢˜ã€‚"
  â”‚
  â””â”€ MVP: å§‹ç»ˆå¤ç”¨å½“å‰ context (ä¸åš AI åˆ¤æ–­)
      æœªæ¥å¢å¼º (M4+): AI è‡ªè¡Œåˆ¤æ–­æ˜¯å¦éœ€è¦è¡¥å……
```

---

## ä¸‰ã€Prompt æ¨¡æ¿ç³»ç»Ÿ

```
ç›®å½•ç»“æ„:
prompts/
â”œâ”€â”€ continue.md        # ç»­å†™
â”œâ”€â”€ dialogue.md        # å¯¹è¯ç”Ÿæˆ
â”œâ”€â”€ describe.md        # åœºæ™¯æå†™
â”œâ”€â”€ brainstorm.md      # å¤´è„‘é£æš´
â”œâ”€â”€ ask_bible.md       # Story Bible é—®ç­”
â”œâ”€â”€ check/
â”‚   â”œâ”€â”€ consistency.md # ä¸€è‡´æ€§æ£€æŸ¥
â”‚   â””â”€â”€ wayne.md       # Wayne åŸåˆ™æ£€æŸ¥
â””â”€â”€ design/
    â”œâ”€â”€ character.md   # è§’è‰²è®¾è®¡
    â””â”€â”€ plot.md        # å‰§æƒ…è®¾è®¡

æ¨¡æ¿ç¤ºä¾‹ (continue.md):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ---                                     â”‚
â”‚ name: ç»­å†™                              â”‚
â”‚ description: ç»­å†™å½“å‰ç« èŠ‚å†…å®¹           â”‚
â”‚ variables:                              â”‚
â”‚   - context                             â”‚
â”‚   - current_content                     â”‚
â”‚   - style_preference                    â”‚
â”‚ ---                                     â”‚
â”‚                                         â”‚
â”‚ ä½ æ˜¯ä¸€ä½ç½‘æ–‡å†™ä½œåŠ©æ‰‹ã€‚                  â”‚
â”‚                                         â”‚
â”‚ {{context}}                             â”‚
â”‚                                         â”‚
â”‚ ## å½“å‰å†…å®¹                             â”‚
â”‚ {{current_content}}                     â”‚
â”‚                                         â”‚
â”‚ è¯·ç»­å†™æ¥ä¸‹æ¥çš„å†…å®¹ã€‚è¦æ±‚:               â”‚
â”‚ - ä¿æŒè§’è‰²æ€§æ ¼ä¸€è‡´                      â”‚
â”‚ - é£æ ¼: {{style_preference}}            â”‚
â”‚ - è‡ªç„¶è¡”æ¥ï¼Œä¸è¦é‡å¤å·²æœ‰å†…å®¹           â”‚
â”‚                                         â”‚
â”‚ ç›´æ¥è¾“å‡ºç»­å†™å†…å®¹ï¼Œæ— éœ€è§£é‡Šã€‚           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å››ã€æ•°æ®æµå‘

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ç”¨æˆ·ç•Œé¢                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  AI é¢æ¿    â”‚  â”‚  ç»­å†™æŒ‰é’®   â”‚  â”‚  Story Bibleé—®ç­”â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                â”‚                  â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚   AIService   â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                   â”‚                   â”‚
       â–¼                   â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Context     â”‚    â”‚  Prompt     â”‚    â”‚  Gemini     â”‚
â”‚ Builder     â”‚    â”‚  Assembler  â”‚    â”‚  Provider   â”‚
â”‚ (FK-based)  â”‚    â”‚             â”‚    â”‚  (2.5 Pro)  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ StoryBible  â”‚
â”‚ Service     â”‚ â†â”€â”€ é€šè¿‡å¤–é”®æŸ¥æ‰¾è§’è‰²/åœ°ç‚¹/ä¼ç¬”
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äº”ã€å…³é”®è®¾è®¡å†³ç­–

### 5.1 ä¸ºä»€ä¹ˆç”¨ SSE è€Œé WebSocket åšæµå¼è¾“å‡º

```
SSE (Server-Sent Events):
  âœ“ å•å‘ï¼šæœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯ï¼ˆæ­£æ˜¯æˆ‘ä»¬éœ€è¦çš„ï¼‰
  âœ“ åŸºäº HTTPï¼Œæ— éœ€é¢å¤–åè®®
  âœ“ è‡ªåŠ¨é‡è¿
  âœ“ æµè§ˆå™¨åŸç”Ÿæ”¯æŒ

WebSocket:
  - åŒå‘é€šä¿¡ï¼ˆAI è¾“å‡ºä¸éœ€è¦ï¼‰
  - éœ€è¦é¢å¤–è¿æ¥ç®¡ç†
  - å¤æ‚åº¦æ›´é«˜

é€‰æ‹©: SSE ç”¨äº AI æµå¼è¾“å‡º
     WebSocket ç”¨äºå…¶ä»–å®æ—¶åŒæ­¥ï¼ˆå¦‚åä½œç¼–è¾‘ï¼‰
```

### 5.2 Context ä¼˜å…ˆçº§ç®—æ³•

> **MVP å˜æ›´**: ä¸ä½¿ç”¨ semantic_relevance è¯„åˆ† (M4 åŠ å…¥)ã€‚
> æ”¹ä¸ºåŸºäº Layer çš„ç¡®å®šæ€§ä¼˜å…ˆçº§ã€‚

```
Layer ä¼˜å…ˆçº§ (é«˜â†’ä½):
  Layer 1 (Required):      priority = 1000
  Layer 2 (FK Expansion):  priority = 800
  Layer 3 (Plot Awareness): priority = 600
  Layer 4 (World Rules):   priority = 400
  Layer 5 (User-Selected): priority = 200

Token é¢„ç®—ä¸è¶³æ—¶ï¼Œä» Layer 5 å¼€å§‹è£å‰ªã€‚
Layer 1 æ°¸è¿œä¸è¢«è£å‰ªã€‚

æœªæ¥å¢å¼º (M4+):
  + semantic_relevance * 100  (è¯­ä¹‰æœç´¢åŠ åˆ†)
  + recency_score * 50        (è¿‘æœŸä½¿ç”¨åŠ åˆ†)
```

### 5.3 Token è®¡æ•°ç­–ç•¥

```
ç²¾ç¡®è®¡æ•° (ç”Ÿäº§ç¯å¢ƒ):
  - ä½¿ç”¨ tiktoken (OpenAI) æˆ–å¯¹åº”çš„ tokenizer
  - æ¯ä¸ª Provider ç”¨è‡ªå·±çš„ tokenizer

ä¼°ç®—è®¡æ•° (å¼€å‘/å¿«é€Ÿ):
  - ä¸­æ–‡: å­—æ•° * 1.5
  - è‹±æ–‡: å•è¯æ•° * 1.3

é€‰æ‹©:
  - Context æ„å»ºæ—¶ç”¨ä¼°ç®—ï¼ˆé€Ÿåº¦å¿«ï¼‰
  - æäº¤å‰ç”¨ç²¾ç¡®è®¡æ•°éªŒè¯
```

---

## å…­ã€é”™è¯¯å¤„ç†

| é”™è¯¯åœºæ™¯ | å¤„ç† |
|----------|------|
| Rate Limit | ç­‰å¾… retry-after ç§’åé‡è¯• |
| Token Limit è¶…å‡º | è‡ªåŠ¨è£å‰ª Contextï¼Œä¿ç•™é«˜ä¼˜å…ˆçº§ |
| Network Timeout | é‡è¯• 3 æ¬¡ï¼Œé—´éš”é€’å¢ |
| Auth Error | æç¤ºç”¨æˆ·æ£€æŸ¥ API Key |
| Content Filter | æç¤ºå†…å®¹è¢«è¿‡æ»¤ï¼Œå»ºè®®ä¿®æ”¹è¾“å…¥ |
| Gemini ä¸å¯ç”¨ | æç¤ºç½‘ç»œé—®é¢˜ï¼Œå»ºè®®ç¨åé‡è¯• |

---

## ä¸ƒã€ç›‘æ§æŒ‡æ ‡

| æŒ‡æ ‡ | ç”¨é€” |
|------|------|
| `ai.request.count` | è¯·æ±‚æ¬¡æ•° |
| `ai.request.latency` | å“åº”æ—¶é—´ |
| `ai.token.input` | è¾“å…¥ Token æ•° |
| `ai.token.output` | è¾“å‡º Token æ•° |
| `ai.error.rate` | é”™è¯¯ç‡ |
---

*Review é‡ç‚¹: ContextBuilder åˆ†å±‚ç»„è£…ã€æ‰¹é‡æŸ¥è¯¢ç­–ç•¥ã€Scoped Relationshipsã€Token é¢„ç®—ç®¡ç†ã€SSE æµå¼è¾“å‡º*
*MVP å†³ç­–: Gemini 2.5 Pro only, FK-based context (no semantic search), Sidebar Preview + Accept, Manual Save*
