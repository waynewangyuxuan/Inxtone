# AIService 模块设计

> AI 调用的核心模块：Provider 抽象、Context 构建、流式输出

---

## 一、模块职责

| 子功能 | 说明 |
|--------|------|
| **Provider 抽象** | 统一接口支持多个 AI 提供商 |
| **Context 构建** | 智能组装上下文，管理 Token 限制 |
| **Prompt 管理** | 模板化的提示词系统 |
| **流式输出** | 实时返回生成内容 |
| **重试与降级** | 错误处理、Provider 切换 |

---

## 二、核心工作流

### 2.1 AI 续写章节

```
用户操作: 在编辑器中按 Ctrl+A，选择 "续写"
    │
    ▼
┌─────────────────────────────────────────┐
│ 1. 收集用户输入                          │
│    - 当前章节内容                        │
│    - 续写长度偏好 (短/中/长)             │
│    - 风格偏好 (简洁/详细)                │
└─────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────┐
│ 2. AIService.continueScene(input)       │
│    │                                     │
│    │  ┌────────────────────────────────┐│
│    │  │ 2.1 构建 Context               ││
│    │  │     ContextBuilder.build()     ││
│    │  └────────────────────────────────┘│
│    │                 │                   │
│    │                 ▼                   │
│    │  ┌────────────────────────────────┐│
│    │  │ 2.2 选择 Prompt 模板           ││
│    │  │     prompts/continue.md        ││
│    │  └────────────────────────────────┘│
│    │                 │                   │
│    │                 ▼                   │
│    │  ┌────────────────────────────────┐│
│    │  │ 2.3 组装最终 Prompt            ││
│    │  │     {context} + {template}     ││
│    │  │     + {current_content}        ││
│    │  └────────────────────────────────┘│
│    │                 │                   │
│    │                 ▼                   │
│    │  ┌────────────────────────────────┐│
│    │  │ 2.4 调用 Provider              ││
│    │  │     provider.stream(prompt)    ││
│    │  └────────────────────────────────┘│
│    │                                     │
└─────────────────────────────────────────┘
    │
    ▼ (流式返回)
┌─────────────────────────────────────────┐
│ 3. 前端逐字显示                          │
│    - 显示生成中动画                      │
│    - 逐 chunk 追加到预览区               │
│    - 显示 Token 使用量                   │
└─────────────────────────────────────────┘
    │
    ▼ (生成完成)
┌─────────────────────────────────────────┐
│ 4. 用户决策                              │
│    ┌─────────┐ ┌─────────┐ ┌─────────┐ │
│    │  采纳   │ │ 重新生成 │ │  放弃   │ │
│    └────┬────┘ └────┬────┘ └────┬────┘ │
│         │           │           │       │
│    追加到正文   重新调用AI    丢弃结果   │
└─────────────────────────────────────────┘
```

### 2.2 Context 构建流程

```
输入: 当前章节 + 用户选择的额外 Context
    │
    ▼
┌─────────────────────────────────────────┐
│ 1. 计算可用 Token 预算                   │
│                                         │
│    总预算 = model.maxTokens             │
│           - reserveForOutput (4000)     │
│           - reserveForPrompt (2000)     │
│                                         │
│    示例: 200000 - 4000 - 2000 = 194000  │
└─────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────┐
│ 2. 自动收集相关内容                      │
│                                         │
│    a. 当前章节内容 (必须)               │
│    b. 前一章节末尾 500 字 (必须)        │
│    c. 本章大纲 (必须)                   │
│    d. 语义搜索相关角色 (Top 3)          │
│    e. 语义搜索相关设定 (Top 3)          │
│    f. 用户手动选择的文件                │
└─────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────┐
│ 3. 优先级排序                            │
│                                         │
│    优先级 (高→低):                       │
│    1. 必须项 (current, previous, outline)│
│    2. 用户显式选择的内容                 │
│    3. 语义相关度 > 0.8 的内容           │
│    4. 语义相关度 0.6-0.8 的内容         │
│    5. 最近使用过的内容                   │
└─────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────┐
│ 4. 按优先级填充，直到达到预算            │
│                                         │
│    used = 0                             │
│    for item in sorted_items:            │
│        tokens = count(item)             │
│        if used + tokens > budget:       │
│            break                        │
│        context.add(item)                │
│        used += tokens                   │
└─────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────┐
│ 5. 格式化输出                            │
│                                         │
│    <context>                            │
│    ## 角色档案                          │
│    ### 林逸                             │
│    {角色信息}                           │
│                                         │
│    ## 相关设定                          │
│    {设定内容}                           │
│                                         │
│    ## 前文                              │
│    {前一章末尾}                         │
│                                         │
│    ## 本章大纲                          │
│    {大纲要点}                           │
│    </context>                           │
└─────────────────────────────────────────┘
```

### 2.3 Provider 调用与降级

```
配置:
┌─────────────────────────────────────────┐
│ ai_config:                               │
│   default_provider: claude               │
│   fallback_order: [claude, openai]      │
│   retry_count: 3                        │
│   retry_delay: 1000ms                   │
│                                         │
│   providers:                            │
│     claude:                             │
│       model: claude-sonnet-4-20250514   │
│       temperature: 0.7                  │
│     openai:                             │
│       model: gpt-4o                     │
│       temperature: 0.7                  │
└─────────────────────────────────────────┘

调用流程:
    │
    ▼
┌─────────────────────────────────────────┐
│ for provider in fallback_order:         │
│   │                                     │
│   │  try:                               │
│   │    for attempt in 1..retry_count:   │
│   │      result = provider.call()       │
│   │      if success: return result      │
│   │      if RateLimit: wait & retry     │
│   │      if Timeout: retry              │
│   │                                     │
│   │  catch AuthError:                   │
│   │    → 跳过此 Provider，尝试下一个   │
│   │                                     │
│   │  catch NetworkError:                │
│   │    → 重试，超过次数后尝试下一个    │
│   │                                     │
│ throw AllProvidersFailed                │
└─────────────────────────────────────────┘
```

---

## 三、Prompt 模板系统

```
目录结构:
prompts/
├── continue.md        # 续写
├── dialogue.md        # 对话生成
├── describe.md        # 场景描写
├── brainstorm.md      # 头脑风暴
├── ask_bible.md       # Story Bible 问答
├── check/
│   ├── consistency.md # 一致性检查
│   └── wayne.md       # Wayne 原则检查
└── design/
    ├── character.md   # 角色设计
    └── plot.md        # 剧情设计

模板示例 (continue.md):
┌─────────────────────────────────────────┐
│ ---                                     │
│ name: 续写                              │
│ description: 续写当前章节内容           │
│ variables:                              │
│   - context                             │
│   - current_content                     │
│   - style_preference                    │
│ ---                                     │
│                                         │
│ 你是一位网文写作助手。                  │
│                                         │
│ {{context}}                             │
│                                         │
│ ## 当前内容                             │
│ {{current_content}}                     │
│                                         │
│ 请续写接下来的内容。要求:               │
│ - 保持角色性格一致                      │
│ - 风格: {{style_preference}}            │
│ - 自然衔接，不要重复已有内容           │
│                                         │
│ 直接输出续写内容，无需解释。           │
└─────────────────────────────────────────┘
```

---

## 四、数据流向

```
┌─────────────────────────────────────────────────────────┐
│                     用户界面                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐ │
│  │  AI 面板    │  │  续写按钮   │  │  Story Bible问答│ │
│  └──────┬──────┘  └──────┬──────┘  └────────┬────────┘ │
└─────────┼────────────────┼──────────────────┼──────────┘
          │                │                  │
          └────────────────┴──────────────────┘
                           │
                   ┌───────┴───────┐
                   │   AIService   │
                   └───────┬───────┘
                           │
       ┌───────────────────┼───────────────────┐
       │                   │                   │
       ▼                   ▼                   ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ Context     │    │  Prompt     │    │  Provider   │
│ Builder     │    │  Templates  │    │  (Claude/   │
│             │    │             │    │   OpenAI)   │
└──────┬──────┘    └─────────────┘    └──────┬──────┘
       │                                      │
       ▼                                      │
┌─────────────┐                               │
│  Search     │                               │
│  Service    │ ←── 语义搜索相关内容 ─────────┘
└─────────────┘
```

---

## 五、关键设计决策

### 5.1 为什么用 SSE 而非 WebSocket 做流式输出

```
SSE (Server-Sent Events):
  ✓ 单向：服务器 → 客户端（正是我们需要的）
  ✓ 基于 HTTP，无需额外协议
  ✓ 自动重连
  ✓ 浏览器原生支持

WebSocket:
  - 双向通信（AI 输出不需要）
  - 需要额外连接管理
  - 复杂度更高

选择: SSE 用于 AI 流式输出
     WebSocket 用于其他实时同步（如协作编辑）
```

### 5.2 Context 优先级算法

```
score = (
    is_required ? 1000 : 0
  + is_user_selected ? 500 : 0
  + semantic_relevance * 100    # 0-100
  + recency_score * 50          # 0-50
)

recency_score =
  最近 1 小时内使用: 50
  最近 1 天内使用: 30
  最近 1 周内使用: 10
  其他: 0
```

### 5.3 Token 计数策略

```
精确计数 (生产环境):
  - 使用 tiktoken (OpenAI) 或对应的 tokenizer
  - 每个 Provider 用自己的 tokenizer

估算计数 (开发/快速):
  - 中文: 字数 * 1.5
  - 英文: 单词数 * 1.3

选择:
  - Context 构建时用估算（速度快）
  - 提交前用精确计数验证
```

---

## 六、错误处理

| 错误场景 | 处理 |
|----------|------|
| Rate Limit | 等待 retry-after 秒后重试 |
| Token Limit 超出 | 自动裁剪 Context，保留高优先级 |
| Network Timeout | 重试 3 次，间隔递增 |
| Auth Error | 提示用户检查 API Key |
| Content Filter | 提示内容被过滤，建议修改输入 |
| All Providers Failed | 提示网络问题，建议稍后重试 |

---

## 七、监控指标

| 指标 | 用途 |
|------|------|
| `ai.request.count` | 请求次数 |
| `ai.request.latency` | 响应时间 |
| `ai.token.input` | 输入 Token 数 |
| `ai.token.output` | 输出 Token 数 |
| `ai.error.rate` | 错误率 |
| `ai.fallback.count` | 降级次数 |

---

*Review 重点: Context 优先级算法、降级策略、Token 计数*
