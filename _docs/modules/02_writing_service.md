> ⚠️ **此文件为旧版副本**。最新版本请参考 `spec/Modules/02_writing_service.md`。

# WritingService 模块设计

> 管理写作流程：章节编辑、版本控制、写作目标

---

## 一、模块职责

| 子功能 | 说明 |
|--------|------|
| **Volume/Chapter CRUD** | 卷、章节的增删改查 |
| **Content Editing** | 内容保存、自动保存 |
| **Version Control** | 版本历史、回滚、对比 |
| **Writing Goals** | 每日目标、连续天数、统计 |
| **Writing Sessions** | 写作时长追踪 |

---

## 二、核心工作流

### 2.1 章节编辑与自动保存

```
用户操作: 打开章节编辑器
    │
    ▼
┌─────────────────────────────────────────┐
│ 1. 加载章节内容                          │
│    WritingService.getChapter(id)        │
│    - content: 正文内容                   │
│    - outline: 本章大纲                   │
│    - word_count: 当前字数                │
└─────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────┐
│ 2. 用户编辑                              │
│    │                                     │
│    │  每次按键 ───→ 更新本地状态         │
│    │                                     │
│    │  防抖 2秒 ───→ 触发自动保存         │
│    │                                     │
└─────────────────────────────────────────┘
    │
    ▼ (自动保存触发)
┌─────────────────────────────────────────┐
│ 3. WritingService.saveContent           │
│    │                                     │
│    ├─→ 计算字数差异 (delta)              │
│    │                                     │
│    ├─→ 更新 chapters 表                  │
│    │   - content, word_count, updated_at │
│    │                                     │
│    ├─→ 检查是否需要创建版本快照          │
│    │   规则: 每 500 字 或 每 30 分钟     │
│    │   └─ 是 → 调用 VersionService       │
│    │                                     │
│    ├─→ 更新今日写作统计                  │
│    │   daily_words += delta              │
│    │                                     │
│    └─→ 发送事件 CHAPTER_SAVED           │
└─────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────┐
│ 4. UI 反馈                               │
│    - 显示 "已自动保存"                   │
│    - 更新字数统计                        │
│    - 更新目标进度条                      │
└─────────────────────────────────────────┘
```

### 2.2 版本控制

```
┌─────────────────────────────────────────────────────────┐
│                    版本创建时机                          │
├─────────────────────────────────────────────────────────┤
│ 自动创建:                                               │
│   - 每增加 500 字                                       │
│   - 每 30 分钟（如有改动）                              │
│   - 关闭编辑器时                                        │
│                                                         │
│ 手动创建:                                               │
│   - 用户点击 "创建版本"                                 │
│   - AI 生成前自动快照                                   │
└─────────────────────────────────────────────────────────┘

版本数据结构:
┌─────────────────────────────────────────┐
│ versions 表                              │
│ ─────────────────────────────────────── │
│ id: 自增                                 │
│ chapter_id: 关联章节                     │
│ content: 完整内容快照                    │
│ word_count: 该版本字数                   │
│ created_at: 创建时间                     │
│ source: 'auto' | 'manual' | 'ai_backup' │
│ summary: 可选的版本说明                  │
└─────────────────────────────────────────┘

版本回滚流程:
    │
    ▼
┌─────────────────────────────────────────┐
│ 1. 显示版本历史列表                      │
│    - 时间、字数、来源                    │
│    - 支持版本对比 (DiffViewer)          │
└─────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────┐
│ 2. 用户选择回滚到某版本                  │
│    - 显示确认对话框                      │
│    - 提示: "当前内容将创建新版本保存"    │
└─────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────┐
│ 3. WritingService.rollbackToVersion     │
│    │                                     │
│    ├─→ 创建当前内容的版本 (备份)         │
│    │   source = 'rollback_backup'       │
│    │                                     │
│    ├─→ 用目标版本内容覆盖当前           │
│    │                                     │
│    └─→ 发送事件 CHAPTER_ROLLBACK        │
└─────────────────────────────────────────┘
```

### 2.3 写作目标追踪

```
目标类型:
┌─────────────────────────────────────────┐
│ daily_goal: 每日字数目标 (如 2000)      │
│ chapter_goal: 本章目标字数 (如 4000)    │
│ project_goal: 总字数目标 (如 500000)    │
└─────────────────────────────────────────┘

统计追踪:
    │
    ▼
┌─────────────────────────────────────────┐
│ writing_stats 表                         │
│ ─────────────────────────────────────── │
│ date: 日期                               │
│ words_written: 当日写作字数              │
│ time_spent: 写作时长（秒）               │
│ chapters_edited: 编辑的章节数            │
└─────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────┐
│ 连续写作计算                             │
│                                         │
│ streak = 从今天往前数，                  │
│          连续有写作记录的天数            │
│                                         │
│ 断签规则: 某天 words_written = 0        │
└─────────────────────────────────────────┘
```

---

## 三、数据流向

```
┌──────────────────────────────────────────────────────────┐
│                     编辑器界面                            │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────────┐ │
│  │内容区域  │  │字数统计 │  │版本历史 │  │ 写作目标    │ │
│  └────┬────┘  └────┬────┘  └────┬────┘  └──────┬──────┘ │
└───────┼────────────┼────────────┼──────────────┼────────┘
        │            │            │              │
        └────────────┴────────────┴──────────────┘
                            │
                    ┌───────┴───────┐
                    │   Writing     │
                    │   Service     │
                    └───────┬───────┘
                            │
        ┌───────────────────┼───────────────────┐
        │                   │                   │
        ▼                   ▼                   ▼
┌───────────────┐   ┌───────────────┐   ┌───────────────┐
│   chapters    │   │   versions    │   │ writing_stats │
│      表       │   │      表       │   │      表       │
└───────────────┘   └───────────────┘   └───────────────┘
```

---

## 四、与其他模块的交互

| 交互模块 | 方向 | 场景 |
|----------|------|------|
| **AIService** | → | AI 续写前获取当前内容和上下文 |
| **StoryBibleService** | ← | 获取大纲、伏笔信息显示在侧边栏 |
| **QualityService** | → | 保存后触发一致性检查 |
| **SearchService** | → | 章节内容变化后更新索引 |
| **EventBus** | → | 发送 SAVED/CREATED/DELETED 事件 |
| **FileWatcher** | ↔ | 支持导出 Markdown，监听外部修改 |

---

## 五、关键设计决策

### 5.1 自动保存策略

```
为什么用防抖而非节流？
- 防抖: 停止输入 2 秒后保存
- 节流: 每 N 秒保存一次

选择防抖的原因:
1. 避免打断用户输入时的保存卡顿
2. 减少不必要的保存次数
3. 用户停止输入 = 一个思考单元结束

特殊情况:
- 超过 5 分钟无保存 → 强制保存一次
- 切换章节/关闭页面 → 立即保存
```

### 5.2 版本存储策略

```
问题: 版本快照会占用大量空间

解决方案: 分层存储

近期版本 (7天内):
  - 保留所有版本
  - 存储完整内容

历史版本 (7天以上):
  - 每天保留最后一个版本
  - 可选: 压缩存储 (gzip)

手动版本:
  - 永久保留
  - 不受清理策略影响
```

### 5.3 章节状态机

```
         ┌─────────┐
         │  draft  │ ←── 新建默认状态
         └────┬────┘
              │ 用户标记完成
              ▼
         ┌─────────┐
         │writing  │ ←── 正在写作
         └────┬────┘
              │ 用户标记完成
              ▼
         ┌─────────┐
         │completed│ ←── 初稿完成
         └────┬────┘
              │ 校对后
              ▼
         ┌─────────┐
         │ final   │ ←── 终稿
         └─────────┘

状态影响:
- draft/writing: 可自由编辑
- completed: 编辑时提示 "已标记完成，确认修改？"
- final: 需要先解锁才能编辑
```

---

## 六、错误处理

| 错误场景 | 处理 |
|----------|------|
| 自动保存失败 | 本地缓存 + 重试 + 提示用户 |
| 版本创建失败 | 不阻断编辑，记录日志，后台重试 |
| 并发编辑冲突 | Last Write Wins + 冲突版本保留 |
| 存储空间不足 | 提示清理旧版本 |

---

*Review 重点: 自动保存防抖、版本分层存储、状态机*
