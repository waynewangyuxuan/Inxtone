# StoryBibleService 模块设计

> 管理故事圣经：角色、世界观、剧情

---

## 一、模块职责

| 子领域 | 功能 |
|--------|------|
| **Characters** | CRUD、关系图、角色弧光 |
| **World** | 规则体系、地点、势力、时间线 |
| **Plot** | 大纲结构、伏笔追踪、钩子管理 |

---

## 二、核心工作流

### 2.1 创建角色

```
用户操作: 点击 "新建角色"
    │
    ▼
┌─────────────────────────────────────────┐
│ 1. 显示角色创建表单                      │
│    - 基本信息 (name, role, archetype)   │
│    - 动机三层 (surface/middle/core)     │
│    - 外貌、声音样本                      │
└─────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────┐
│ 2. 前端校验                              │
│    - 名称必填                            │
│    - 角色定位必选                         │
└─────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────┐
│ 3. 调用 StoryBibleService.createCharacter │
│    │                                     │
│    ├─→ 检查名称是否重复                   │
│    │   └─ 重复 → 抛出 DuplicateError     │
│    │                                     │
│    ├─→ 生成唯一 ID (nanoid)              │
│    │                                     │
│    ├─→ 写入 characters 表                │
│    │                                     │
│    ├─→ 生成 Embedding                    │
│    │   └─ 内容: name + role + motivations │
│    │                                     │
│    ├─→ 写入 embeddings 表                │
│    │                                     │
│    └─→ 发送事件 CHARACTER_CREATED        │
└─────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────┐
│ 4. 可选: 导出 Markdown 文件              │
│    - 写入 story-bible/02_characters/    │
│    - 文件名: {id}_{name}.md             │
└─────────────────────────────────────────┘
```

### 2.2 建立角色关系

```
用户操作: 在关系编辑器中连线
    │
    ▼
┌─────────────────────────────────────────┐
│ 1. 选择两个角色 + 关系类型               │
│    - types: romantic/rival/mentor/...   │
│    - 可填写: 张力程度 (1-10)            │
│    - 可填写: 关系描述                    │
└─────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────┐
│ 2. StoryBibleService.createRelationship │
│    │                                     │
│    ├─→ 检查是否已存在相同关系            │
│    │                                     │
│    ├─→ 写入 relationships 表             │
│    │   - from_id, to_id, type, tension  │
│    │                                     │
│    └─→ 发送事件 RELATIONSHIP_CREATED    │
└─────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────┐
│ 3. 关系图自动更新                        │
│    - Web: D3.js 力导向图刷新            │
│    - TUI: 文本关系列表刷新              │
└─────────────────────────────────────────┘
```

### 2.3 伏笔管理

```
用户操作: 在写作中标记伏笔
    │
    ▼
┌─────────────────────────────────────────┐
│ 1. 伏笔登记                              │
│    - name: 伏笔名称                      │
│    - description: 描述                   │
│    - planted_chapter: 埋设章节          │
│    - expected_harvest: 预计收割章节      │
└─────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────┐
│ 2. StoryBibleService.createForeshadowing│
│    │                                     │
│    ├─→ 写入 foreshadowing 表            │
│    │   status = 'active'                │
│    │                                     │
│    └─→ 发送事件 FORESHADOWING_CREATED   │
└─────────────────────────────────────────┘
    │
    ▼
伏笔追踪器显示:
    │
    │  [====埋设====]────────────[预计收割]
    │       Ch.3                   Ch.89
    │
    ▼
┌─────────────────────────────────────────┐
│ 3. 伏笔收割                              │
│    - 用户标记: 已在某章节收割            │
│    - 或: 一致性检查发现逾期未收割        │
│                                         │
│    StoryBibleService.resolveForeshadowing│
│    - status = 'resolved'                │
│    - actual_harvest_chapter = N         │
└─────────────────────────────────────────┘
```

---

## 三、数据流向

```
┌──────────────────────────────────────────────────────────┐
│                     用户界面                              │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────────┐ │
│  │角色列表  │  │关系图   │  │伏笔追踪 │  │ 世界观设定  │ │
│  └────┬────┘  └────┬────┘  └────┬────┘  └──────┬──────┘ │
└───────┼────────────┼────────────┼──────────────┼────────┘
        │            │            │              │
        └────────────┴────────────┴──────────────┘
                            │
                    ┌───────┴───────┐
                    │ StoryBible    │
                    │   Service     │
                    └───────┬───────┘
                            │
        ┌───────────────────┼───────────────────┐
        │                   │                   │
        ▼                   ▼                   ▼
┌───────────────┐   ┌───────────────┐   ┌───────────────┐
│  characters   │   │ relationships │   │ foreshadowing │
│    表         │   │      表       │   │      表       │
└───────────────┘   └───────────────┘   └───────────────┘
        │
        ▼
┌───────────────┐
│  embeddings   │ ←── 用于语义搜索
│     表        │
└───────────────┘
```

---

## 四、与其他模块的交互

| 交互模块 | 方向 | 场景 |
|----------|------|------|
| **AIService** | → | AI 续写时获取角色档案作为 Context |
| **SearchService** | → | 搜索角色、设定时查询 |
| **QualityService** | ← | 一致性检查需要读取角色属性 |
| **WritingService** | ↔ | 写作时引用角色、标记伏笔 |
| **EventBus** | → | 发送 CRUD 事件 |
| **FileWatcher** | ← | 外部编辑 Markdown 后同步 |

---

## 五、关键设计决策

### 5.1 ID 生成策略

```
角色 ID: nanoid(10) + 校验前缀
示例: char_a1b2c3d4e5

为什么不用自增ID？
- 支持跨项目引用
- 便于 Git 合并
- URL 友好
```

### 5.2 Embedding 更新策略

```
触发时机:
1. 创建角色 → 立即生成
2. 更新角色 → 重新生成
3. 批量导入 → 队列异步生成

内容组成:
- name + aliases
- role + archetype
- motivations (三层)
- appearance 关键词
- voice_sample 关键句

不包含:
- relationships (单独索引)
- 版本历史
```

### 5.3 关系的双向性

```
存储: 只存一条记录 (from < to 的方向)

查询: 查两个方向
  WHERE from_id = ? OR to_id = ?

显示: 根据 from/to 决定描述文本
  林逸 → 苏瑶: "爱慕"
  苏瑶 → 林逸: "被爱慕"
```

---

## 六、错误处理

| 错误场景 | 处理 |
|----------|------|
| 角色名重复 | 抛出 `DuplicateEntityError`，提示用户改名 |
| 删除被引用的角色 | 提示有N个关系、M章内容引用，确认后级联清理 |
| Embedding 生成失败 | 重试3次，失败后标记为 `embedding_pending` |
| 伏笔逾期未收割 | 不阻断，作为 Warning 显示在质量检查中 |

---

*Review 重点: ID生成、Embedding策略、关系双向性*
